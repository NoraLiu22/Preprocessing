nqlevgpgxgdsqqjirekexitavsfkvsfmlqbsqswi length 5 19442 page 19442 
<html>
<head>
<title>r37973 MediaWiki - Code Review archive</title>
<meta charset="utf-8">
<link rel="stylesheet" href="../ext.codereview.styles.css"/>
</head>
<body>
<h1>r37973 MediaWiki - Code Review archive</h1>
<div id="mw-content-text" class="mw-body-content"><form action="/wiki/Special:Code/MediaWiki/37973" method="post"><table class="mw-codereview-meta"><tr><td>Repository:</td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki" title="Special:Code/MediaWiki">MediaWiki</a></td></tr>
<tr><td>Revision:</td><td>&lt;&#160;<a href="./37972.html" title="Special:Code/MediaWiki/37972">r37972</a>‎ | <b>r37973</b> | <a href="./37974.html" title="Special:Code/MediaWiki/37974">r37974</a>&#160;&gt;</td></tr>
<tr><td>Date:</td><td>19:49, 23 July 2008</td></tr>
<tr><td>Author:</td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki/author/simetrical" title="Special:Code/MediaWiki/author/simetrical">simetrical</a></td></tr>
<tr><td>Status:</td><td>old</td></tr>
<tr><td>Tags:</td><td></td></tr>
<tr><td>Comment:</td><td><div class="mw-codereview-message">(<a class="external" href="https://bugzilla.wikimedia.org/show_bug.cgi?id=8068">bug 8068</a>) New __INDEX__ and __NOINDEX__ magic words allow control of search engine indexing on a per-article basis.  Remarks:<br />
* Currently __INDEX__ will override __NOINDEX__ regardless of their relative positions, due to the way things are written.  Instead, the last one on the page should win.  This should be pretty easy to fix.<br />
* __INDEX__ and __NOINDEX__ override $wgArticleRobotPolicies.  This is almost certainly incorrect, but it's not totally obvious how to fix it, because of the way the code is structured.  Probably not a big deal, but should probably be fixed at some point.<br />
* Anyone can add and remove the magic words, and there's no config option to disable them.  It's not obvious whether this is okay or not.  It would be a one-line change to OutputPage.php to have a config option to ignore the magic words, maybe per-namespace or who knows what.</div></td></tr>
<tr><td>Modified paths:</td><td><div class='mw-codereview-paths mw-content-ltr'><ul>
<li><b>/trunk/phase3/RELEASE-NOTES</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2FRELEASE-NOTES" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/includes/MagicWord.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2FMagicWord.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/includes/OutputPage.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2FOutputPage.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/includes/parser/Parser.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2Fparser%2FParser.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/includes/parser/ParserOutput.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2Fparser%2FParserOutput.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/languages/messages/MessagesEn.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Flanguages%2Fmessages%2FMessagesEn.php" title="Special:Code/MediaWiki">history</a>)</li>
</ul></div>
</td></tr>
</table>
<h2>Diff <small>[<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki/37973&amp;action=purge" title="Special:Code/MediaWiki/37973">purge</a>]</small></h2><div class='mw-codereview-diff' id='mw-codereview-diff'><table class="mw-codereview-diff"><tr id="1" class="patchedfile"><td colspan="3">Index: trunk/phase3/languages/messages/MessagesEn.php</td></tr>



<tr id="5"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -340,6 +340,8 @@</span></td></tr>
<tr id="6"><td class="linenumbers">341</td><td class="linenumbers">341</td><td class="unchanged"><span> 	'hiddencat'              => array( 1,    '__HIDDENCAT__'          ),</span></td></tr>
<tr id="7"><td class="linenumbers">342</td><td class="linenumbers">342</td><td class="unchanged"><span> 	'pagesincategory'        => array( 1,    'PAGESINCATEGORY', 'PAGESINCAT' ),</span></td></tr>
<tr id="8"><td class="linenumbers">343</td><td class="linenumbers">343</td><td class="unchanged"><span> 	'pagesize'               => array( 1,    'PAGESIZE'               ),</span></td></tr>
<tr id="9"><td class="linenumbers"> </td><td class="linenumbers">344</td><td class="ins"><ins>+	'index'                  => array( 1,    '__INDEX__'              ),</ins></td></tr>
<tr id="10"><td class="linenumbers"> </td><td class="linenumbers">345</td><td class="ins"><ins>+	'noindex'                => array( 1,    '__NOINDEX__'            ),</ins></td></tr>
<tr id="11"><td class="linenumbers">344</td><td class="linenumbers">346</td><td class="unchanged"><span> );</span></td></tr>
<tr id="12"><td class="linenumbers">345</td><td class="linenumbers">347</td><td class="unchanged"><span> </span></td></tr>
<tr id="13"><td class="linenumbers">346</td><td class="linenumbers">348</td><td class="unchanged"><span> /**</span></td></tr>
<tr id="14" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/parser/Parser.php</td></tr>



<tr id="18"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -3380,6 +3380,15 @@</span></td></tr>
<tr id="19"><td class="linenumbers">3381</td><td class="linenumbers">3381</td><td class="unchanged"><span> 				wfDebug( __METHOD__.": [[MediaWiki:hidden-category-category]] is not a valid title!\n" );</span></td></tr>
<tr id="20"><td class="linenumbers">3382</td><td class="linenumbers">3382</td><td class="unchanged"><span> 			}</span></td></tr>
<tr id="21"><td class="linenumbers">3383</td><td class="linenumbers">3383</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="22"><td class="linenumbers"> </td><td class="linenumbers">3384</td><td class="ins"><ins>+		# (bug 8068) Allow control over whether robots index a page.  FIXME:</ins></td></tr>
<tr id="23"><td class="linenumbers"> </td><td class="linenumbers">3385</td><td class="ins"><ins>+		# __INDEX__ always overrides __NOINDEX__ here!  This is not desirable,</ins></td></tr>
<tr id="24"><td class="linenumbers"> </td><td class="linenumbers">3386</td><td class="ins"><ins>+		# the last one on the page should win.</ins></td></tr>
<tr id="25"><td class="linenumbers"> </td><td class="linenumbers">3387</td><td class="ins"><ins>+		if( isset( $this->mDoubleUnderscores['noindex'] ) ) {</ins></td></tr>
<tr id="26"><td class="linenumbers"> </td><td class="linenumbers">3388</td><td class="ins"><ins>+			$this->mOutput->setIndexPolicy( 'noindex' );</ins></td></tr>
<tr id="27"><td class="linenumbers"> </td><td class="linenumbers">3389</td><td class="ins"><ins>+		} elseif( isset( $this->mDoubleUnderscores['index'] ) ) {</ins></td></tr>
<tr id="28"><td class="linenumbers"> </td><td class="linenumbers">3390</td><td class="ins"><ins>+			$this->mOutput->setIndexPolicy( 'index' );</ins></td></tr>
<tr id="29"><td class="linenumbers"> </td><td class="linenumbers">3391</td><td class="ins"><ins>+		}</ins></td></tr>
<tr id="30"><td class="linenumbers"> </td><td class="linenumbers">3392</td><td class="ins"><ins>+</ins></td></tr>
<tr id="31"><td class="linenumbers">3384</td><td class="linenumbers">3393</td><td class="unchanged"><span> 		return $text;</span></td></tr>
<tr id="32"><td class="linenumbers">3385</td><td class="linenumbers">3394</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="33"><td class="linenumbers">3386</td><td class="linenumbers">3395</td><td class="unchanged"><span> </span></td></tr>
<tr id="34" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/parser/ParserOutput.php</td></tr>



<tr id="38"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -24,6 +24,7 @@</span></td></tr>
<tr id="39"><td class="linenumbers">25</td><td class="linenumbers">25</td><td class="unchanged"><span> 		$mWarnings,         # Warning text to be returned to the user. Wikitext formatted, in the key only</span></td></tr>
<tr id="40"><td class="linenumbers">26</td><td class="linenumbers">26</td><td class="unchanged"><span> 		$mSections,         # Table of contents</span></td></tr>
<tr id="41"><td class="linenumbers">27</td><td class="linenumbers">27</td><td class="unchanged"><span> 		$mProperties;       # Name/value pairs to be cached in the DB</span></td></tr>
<tr id="42"><td class="linenumbers"> </td><td class="linenumbers">28</td><td class="ins"><ins>+	private $mIndexPolicy = '';	# 'index' or 'noindex'?  Any other value will result in no change.</ins></td></tr>
<tr id="43"><td class="linenumbers">28</td><td class="linenumbers">29</td><td class="unchanged"><span> </span></td></tr>
<tr id="44"><td class="linenumbers">29</td><td class="linenumbers">30</td><td class="unchanged"><span> 	/**</span></td></tr>
<tr id="45"><td class="linenumbers">30</td><td class="linenumbers">31</td><td class="unchanged"><span> 	 * Overridden title for display</span></td></tr>
<tr id="46"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -69,6 +70,7 @@</span></td></tr>
<tr id="47"><td class="linenumbers">70</td><td class="linenumbers">71</td><td class="unchanged"><span> 	function getSubtitle()               { return $this->mSubtitle; }</span></td></tr>
<tr id="48"><td class="linenumbers">71</td><td class="linenumbers">72</td><td class="unchanged"><span> 	function getOutputHooks()            { return (array)$this->mOutputHooks; }</span></td></tr>
<tr id="49"><td class="linenumbers">72</td><td class="linenumbers">73</td><td class="unchanged"><span> 	function getWarnings()               { return array_keys( $this->mWarnings ); }</span></td></tr>
<tr id="50"><td class="linenumbers"> </td><td class="linenumbers">74</td><td class="ins"><ins>+	function getIndexPolicy()            { return $this->mIndexPolicy; }</ins></td></tr>
<tr id="51"><td class="linenumbers">73</td><td class="linenumbers">75</td><td class="unchanged"><span> </span></td></tr>
<tr id="52"><td class="linenumbers">74</td><td class="linenumbers">76</td><td class="unchanged"><span> 	function containsOldMagic()          { return $this->mContainsOldMagic; }</span></td></tr>
<tr id="53"><td class="linenumbers">75</td><td class="linenumbers">77</td><td class="unchanged"><span> 	function setText( $text )            { return wfSetVar( $this->mText, $text ); }</span></td></tr>
<tr id="54"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -78,6 +80,7 @@</span></td></tr>
<tr id="55"><td class="linenumbers">79</td><td class="linenumbers">81</td><td class="unchanged"><span> 	function setCacheTime( $t )          { return wfSetVar( $this->mCacheTime, $t ); }</span></td></tr>
<tr id="56"><td class="linenumbers">80</td><td class="linenumbers">82</td><td class="unchanged"><span> 	function setTitleText( $t )          { return wfSetVar( $this->mTitleText, $t ); }</span></td></tr>
<tr id="57"><td class="linenumbers">81</td><td class="linenumbers">83</td><td class="unchanged"><span> 	function setSections( $toc )         { return wfSetVar( $this->mSections, $toc ); }</span></td></tr>
<tr id="58"><td class="linenumbers"> </td><td class="linenumbers">84</td><td class="ins"><ins>+	function setIndexPolicy( $policy )   { return wfSetVar( $this->mIndexPolicy, $policy ); }</ins></td></tr>
<tr id="59"><td class="linenumbers">82</td><td class="linenumbers">85</td><td class="unchanged"><span> </span></td></tr>
<tr id="60"><td class="linenumbers">83</td><td class="linenumbers">86</td><td class="unchanged"><span> 	function addCategory( $c, $sort )    { $this->mCategories[$c] = $sort; }</span></td></tr>
<tr id="61"><td class="linenumbers">84</td><td class="linenumbers">87</td><td class="unchanged"><span> 	function addLanguageLink( $t )       { $this->mLanguageLinks[] = $t; }</span></td></tr>
<tr id="62" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/MagicWord.php</td></tr>



<tr id="66"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -105,6 +105,8 @@</span></td></tr>
<tr id="67"><td class="linenumbers">106</td><td class="linenumbers">106</td><td class="unchanged"><span> 		'numberofadmins',</span></td></tr>
<tr id="68"><td class="linenumbers">107</td><td class="linenumbers">107</td><td class="unchanged"><span> 		'defaultsort',</span></td></tr>
<tr id="69"><td class="linenumbers">108</td><td class="linenumbers">108</td><td class="unchanged"><span> 		'pagesincategory',</span></td></tr>
<tr id="70"><td class="linenumbers"> </td><td class="linenumbers">109</td><td class="ins"><ins>+		'index',</ins></td></tr>
<tr id="71"><td class="linenumbers"> </td><td class="linenumbers">110</td><td class="ins"><ins>+		'noindex',</ins></td></tr>
<tr id="72"><td class="linenumbers">109</td><td class="linenumbers">111</td><td class="unchanged"><span> 	);</span></td></tr>
<tr id="73"><td class="linenumbers">110</td><td class="linenumbers">112</td><td class="unchanged"><span> </span></td></tr>
<tr id="74"><td class="linenumbers">111</td><td class="linenumbers">113</td><td class="unchanged"><span> 	/* Array of caching hints for ParserCache */</span></td></tr>
<tr id="75"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -153,6 +155,8 @@</span></td></tr>
<tr id="76"><td class="linenumbers">154</td><td class="linenumbers">156</td><td class="unchanged"><span> 		'noeditsection',</span></td></tr>
<tr id="77"><td class="linenumbers">155</td><td class="linenumbers">157</td><td class="unchanged"><span> 		'newsectionlink',</span></td></tr>
<tr id="78"><td class="linenumbers">156</td><td class="linenumbers">158</td><td class="unchanged"><span> 		'hiddencat',</span></td></tr>
<tr id="79"><td class="linenumbers"> </td><td class="linenumbers">159</td><td class="ins"><ins>+		'index',</ins></td></tr>
<tr id="80"><td class="linenumbers"> </td><td class="linenumbers">160</td><td class="ins"><ins>+		'noindex',</ins></td></tr>
<tr id="81"><td class="linenumbers">157</td><td class="linenumbers">161</td><td class="unchanged"><span> 	);</span></td></tr>
<tr id="82"><td class="linenumbers">158</td><td class="linenumbers">162</td><td class="unchanged"><span> </span></td></tr>
<tr id="83"><td class="linenumbers">159</td><td class="linenumbers">163</td><td class="unchanged"><span> </span></td></tr>
<tr id="84" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/OutputPage.php</td></tr>



<tr id="88"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -475,6 +475,8 @@</span></td></tr>
<tr id="89"><td class="linenumbers">476</td><td class="linenumbers">476</td><td class="unchanged"><span> 		$this->mLanguageLinks += $parserOutput->getLanguageLinks();</span></td></tr>
<tr id="90"><td class="linenumbers">477</td><td class="linenumbers">477</td><td class="unchanged"><span> 		$this->addCategoryLinks( $parserOutput->getCategories() );</span></td></tr>
<tr id="91"><td class="linenumbers">478</td><td class="linenumbers">478</td><td class="unchanged"><span> 		$this->mNewSectionLink = $parserOutput->getNewSection();</span></td></tr>
<tr id="92"><td class="linenumbers"> </td><td class="linenumbers">479</td><td class="ins"><ins>+		# FIXME: This probably overrides $wgArticleRobotPolicies, is that wise?</ins></td></tr>
<tr id="93"><td class="linenumbers"> </td><td class="linenumbers">480</td><td class="ins"><ins>+		$this->setIndexPolicy( $parserOutput->getIndexPolicy() );</ins></td></tr>
<tr id="94"><td class="linenumbers">479</td><td class="linenumbers">481</td><td class="unchanged"><span> 		$this->addKeywords( $parserOutput );</span></td></tr>
<tr id="95"><td class="linenumbers">480</td><td class="linenumbers">482</td><td class="unchanged"><span> 		$this->mParseWarnings = $parserOutput->getWarnings();</span></td></tr>
<tr id="96"><td class="linenumbers">481</td><td class="linenumbers">483</td><td class="unchanged"><span> 		if ( $parserOutput->getCacheTime() == -1 ) {</span></td></tr>
<tr id="97" class="patchedfile"><td colspan="3">Index: trunk/phase3/RELEASE-NOTES</td></tr>



<tr id="101"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -24,7 +24,8 @@</span></td></tr>
<tr id="102"><td class="linenumbers">25</td><td class="linenumbers">25</td><td class="unchanged"><span> </span></td></tr>
<tr id="103"><td class="linenumbers">26</td><td class="linenumbers">26</td><td class="unchanged"><span> === New features in 1.14 ===</span></td></tr>
<tr id="104"><td class="linenumbers">27</td><td class="linenumbers">27</td><td class="unchanged"><span> </span></td></tr>
<tr id="105"><td class="linenumbers">28</td><td class="linenumbers"> </td><td class="del"><del>-None yet</del></td></tr>
<tr id="106"><td class="linenumbers"> </td><td class="linenumbers">28</td><td class="ins"><ins>+* (bug 8068) New __INDEX__ and __NOINDEX__ magic words allow control of search</ins></td></tr>
<tr id="107"><td class="linenumbers"> </td><td class="linenumbers">29</td><td class="ins"><ins>+engine indexing on a per-article basis.</ins></td></tr>
<tr id="108"><td class="linenumbers">29</td><td class="linenumbers">30</td><td class="unchanged"><span> </span></td></tr>
<tr id="109"><td class="linenumbers">30</td><td class="linenumbers">31</td><td class="unchanged"><span> === Bug fixes in 1.14 ===</span></td></tr>
<tr id="110"><td class="linenumbers">31</td><td class="linenumbers">32</td><td class="unchanged"><span> </span></td></tr>
</table>
</div>
<h2 id='code-referenced'>Past revisions this follows-up on</h2>
<table border='1' class='wikitable'><tr><th>Revision</th><th>Commit summary</th><th>Author</th><th>Date</th></tr><tr class='mw-codereview-status-old'><td><a href="./37968.html" title="Special:Code/MediaWiki/37968">r37968</a></td><td>Refactor a bit preparatory to fixing <a class="external" href="https://bugzilla.wikimedia.org/show_bug.cgi?id=8068">bug 8068</a>: rewrite the robot policy stuff...</td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki/author/simetrical" title="Special:Code/MediaWiki/author/simetrical">simetrical</a></td><td>19:05, 23 July 2008</td></tr></table><h2 id='code-changes'>Status &amp; tagging log</h2>
<ul class='mw-codereview-changes'><li>15:29, 12 September 2011&#160;<a href="https://www.mediawiki.org/wiki/User:Meno25" class="mw-userlink" title="User:Meno25"><bdi>Meno25</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Meno25" class="mw-usertoollinks-talk" title="User talk:Meno25">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Meno25" class="mw-usertoollinks-contribs" title="Special:Contributions/Meno25">contribs</a>)</span>&#160;changed the <b>status</b> of r37973 <i>[<b>removed:</b> ok&#160;<b>added:</b> old]</i></li></ul></form></div>
</body>
</html>
 contentType 9 text/html url 64 https://static-codereview.wikimedia.org:443/MediaWiki/37973.html responseCode 3 200 