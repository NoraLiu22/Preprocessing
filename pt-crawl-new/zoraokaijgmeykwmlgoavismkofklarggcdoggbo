zoraokaijgmeykwmlgoavismkofklarggcdoggbo length 5 41297 page 41297 
<html>
<head>
<title>r32932 MediaWiki - Code Review archive</title>
<meta charset="utf-8">
<link rel="stylesheet" href="../ext.codereview.styles.css"/>
</head>
<body>
<h1>r32932 MediaWiki - Code Review archive</h1>
<div id="mw-content-text" class="mw-body-content"><form action="/wiki/Special:Code/MediaWiki/32932" method="post"><table class="mw-codereview-meta"><tr><td>Repository:</td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki" title="Special:Code/MediaWiki">MediaWiki</a></td></tr>
<tr><td>Revision:</td><td>&lt;&#160;<a href="./32931.html" title="Special:Code/MediaWiki/32931">r32931</a>‎ | <b>r32932</b> | <a href="./32933.html" title="Special:Code/MediaWiki/32933">r32933</a>&#160;&gt;</td></tr>
<tr><td>Date:</td><td>22:11, 7 April 2008</td></tr>
<tr><td>Author:</td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki/author/brion" title="Special:Code/MediaWiki/author/brion">brion</a></td></tr>
<tr><td>Status:</td><td>old</td></tr>
<tr><td>Tags:</td><td></td></tr>
<tr><td>Comment:</td><td><div class="mw-codereview-message">* (6943) Added PAGESINCATEGORY: magic word<br />
Patch by Mr.Z-man, <a class="external" href="https://bugzilla.wikimedia.org/attachment.cgi?id=4793">https://bugzilla.wikimedia.org/attachment.cgi?id=4793</a><br />
Moves some of the 'expensive parser function' tracking to core.</div></td></tr>
<tr><td>Modified paths:</td><td><div class='mw-codereview-paths mw-content-ltr'><ul>
<li><b>/trunk/extensions/ParserFunctions/ParserFunctions.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fextensions%2FParserFunctions%2FParserFunctions.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/RELEASE-NOTES</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2FRELEASE-NOTES" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/includes/CoreParserFunctions.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2FCoreParserFunctions.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/includes/DefaultSettings.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2FDefaultSettings.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/includes/MagicWord.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2FMagicWord.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/includes/Parser.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2FParser.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/languages/messages/MessagesEn.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Flanguages%2Fmessages%2FMessagesEn.php" title="Special:Code/MediaWiki">history</a>)</li>
</ul></div>
</td></tr>
</table>
<h2>Diff <small>[<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki/32932&amp;action=purge" title="Special:Code/MediaWiki/32932">purge</a>]</small></h2><div class='mw-codereview-diff' id='mw-codereview-diff'><table class="mw-codereview-diff"><tr id="1" class="patchedfile"><td colspan="3">Index: trunk/extensions/ParserFunctions/ParserFunctions.php</td></tr>



<tr id="5"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -16,10 +16,7 @@</span></td></tr>
<tr id="6"><td class="linenumbers">17</td><td class="linenumbers">17</td><td class="unchanged"><span> </span></td></tr>
<tr id="7"><td class="linenumbers">18</td><td class="linenumbers">18</td><td class="unchanged"><span> $wgExtensionMessagesFiles['ParserFunctions'] = dirname(__FILE__) . '/ParserFunctions.i18n.php';</span></td></tr>
<tr id="8"><td class="linenumbers">19</td><td class="linenumbers">19</td><td class="unchanged"><span> $wgHooks['LanguageGetMagic'][]       = 'wfParserFunctionsLanguageGetMagic';</span></td></tr>
<tr id="9"><td class="linenumbers">20</td><td class="linenumbers"> </td><td class="del"><del>-$wgHooks['ParserLimitReport'][]      = 'wfParserFunctionsLimitReport';</del></td></tr>
<tr id="10"><td class="linenumbers">21</td><td class="linenumbers">20</td><td class="unchanged"><span> </span></td></tr>
<tr id="11"><td class="linenumbers">22</td><td class="linenumbers"> </td><td class="del"><del>-$wgMaxIfExistCount = 100;</del></td></tr>
<tr id="12"><td class="linenumbers">23</td><td class="linenumbers"> </td><td class="del"><del>-</del></td></tr>
<tr id="13"><td class="linenumbers">24</td><td class="linenumbers">21</td><td class="unchanged"><span> class ExtParserFunctions {</span></td></tr>
<tr id="14"><td class="linenumbers">25</td><td class="linenumbers">22</td><td class="unchanged"><span> 	var $mExprParser;</span></td></tr>
<tr id="15"><td class="linenumbers">26</td><td class="linenumbers">23</td><td class="unchanged"><span> 	var $mTimeCache = array();</span></td></tr>
<tr id="16"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -55,7 +52,6 @@</span></td></tr>
<tr id="17"><td class="linenumbers">56</td><td class="linenumbers">53</td><td class="unchanged"><span> </span></td></tr>
<tr id="18"><td class="linenumbers">57</td><td class="linenumbers">54</td><td class="unchanged"><span> 	function clearState(&amp;$parser) {</span></td></tr>
<tr id="19"><td class="linenumbers">58</td><td class="linenumbers">55</td><td class="unchanged"><span> 		$this->mTimeChars = 0;</span></td></tr>
<tr id="20"><td class="linenumbers">59</td><td class="linenumbers"> </td><td class="del"><del>-		$parser->pf_ifexist_count = 0;</del></td></tr>
<tr id="21"><td class="linenumbers">60</td><td class="linenumbers">56</td><td class="unchanged"><span> 		$parser->pf_ifexist_breakdown = array();</span></td></tr>
<tr id="22"><td class="linenumbers">61</td><td class="linenumbers">57</td><td class="unchanged"><span> 		return true;</span></td></tr>
<tr id="23"><td class="linenumbers">62</td><td class="linenumbers">58</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="24"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -315,8 +311,8 @@</span></td></tr>
<tr id="25"><td class="linenumbers">316</td><td class="linenumbers">312</td><td class="unchanged"><span> </span></td></tr>
<tr id="26"><td class="linenumbers">317</td><td class="linenumbers">313</td><td class="unchanged"><span> 	function incrementIfexistCount( $parser, $frame ) {</span></td></tr>
<tr id="27"><td class="linenumbers">318</td><td class="linenumbers">314</td><td class="unchanged"><span> 		// Don't let this be called more than a certain number of times. It tends to make the database explode.</span></td></tr>
<tr id="28"><td class="linenumbers">319</td><td class="linenumbers"> </td><td class="del"><del>-		global $wgMaxIfExistCount;</del></td></tr>
<tr id="29"><td class="linenumbers">320</td><td class="linenumbers"> </td><td class="del"><del>-		$parser->pf_ifexist_count++;</del></td></tr>
<tr id="30"><td class="linenumbers"> </td><td class="linenumbers">315</td><td class="ins"><ins>+		global $wgExpensiveParserFunctionLimit;</ins></td></tr>
<tr id="31"><td class="linenumbers"> </td><td class="linenumbers">316</td><td class="ins"><ins>+		$parser->mExpensiveFunctionCount++;</ins></td></tr>
<tr id="32"><td class="linenumbers">321</td><td class="linenumbers">317</td><td class="unchanged"><span> 		if ( $frame ) {</span></td></tr>
<tr id="33"><td class="linenumbers">322</td><td class="linenumbers">318</td><td class="unchanged"><span> 			$pdbk = $frame->getPDBK( 1 );</span></td></tr>
<tr id="34"><td class="linenumbers">323</td><td class="linenumbers">319</td><td class="unchanged"><span> 			if ( !isset( $parser->pf_ifexist_breakdown[$pdbk] ) ) {</span></td></tr>
<tr id="35"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -324,7 +320,7 @@</span></td></tr>
<tr id="36"><td class="linenumbers">325</td><td class="linenumbers">321</td><td class="unchanged"><span> 			}</span></td></tr>
<tr id="37"><td class="linenumbers">326</td><td class="linenumbers">322</td><td class="unchanged"><span> 			$parser->pf_ifexist_breakdown[$pdbk] ++;</span></td></tr>
<tr id="38"><td class="linenumbers">327</td><td class="linenumbers">323</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="39"><td class="linenumbers">328</td><td class="linenumbers"> </td><td class="del"><del>-		return $parser->pf_ifexist_count &lt;= $wgMaxIfExistCount;</del></td></tr>
<tr id="40"><td class="linenumbers"> </td><td class="linenumbers">324</td><td class="ins"><ins>+		return $parser->mExpensiveFunctionCount &lt;= $wgExpensiveParserFunctionLimit;</ins></td></tr>
<tr id="41"><td class="linenumbers">329</td><td class="linenumbers">325</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="42"><td class="linenumbers">330</td><td class="linenumbers">326</td><td class="unchanged"><span> </span></td></tr>
<tr id="43"><td class="linenumbers">331</td><td class="linenumbers">327</td><td class="unchanged"><span> 	function ifexist( &amp;$parser, $title = '', $then = '', $else = '' ) {</span></td></tr>
<tr id="44"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -357,15 +353,14 @@</span></td></tr>
<tr id="45"><td class="linenumbers">358</td><td class="linenumbers">354</td><td class="unchanged"><span> 			} else {</span></td></tr>
<tr id="46"><td class="linenumbers">359</td><td class="linenumbers">355</td><td class="unchanged"><span> 				$pdbk = $title->getPrefixedDBkey();</span></td></tr>
<tr id="47"><td class="linenumbers">360</td><td class="linenumbers">356</td><td class="unchanged"><span> 				$lc = LinkCache::singleton();</span></td></tr>
<tr id="48"><td class="linenumbers"> </td><td class="linenumbers">357</td><td class="ins"><ins>+				if ( !$this->incrementIfexistCount( $parser, $frame ) ) {</ins></td></tr>
<tr id="49"><td class="linenumbers"> </td><td class="linenumbers">358</td><td class="ins"><ins>+					return $else;</ins></td></tr>
<tr id="50"><td class="linenumbers"> </td><td class="linenumbers">359</td><td class="ins"><ins>+				}</ins></td></tr>
<tr id="51"><td class="linenumbers">361</td><td class="linenumbers">360</td><td class="unchanged"><span> 				if ( $lc->getGoodLinkID( $pdbk ) ) {</span></td></tr>
<tr id="52"><td class="linenumbers">362</td><td class="linenumbers">361</td><td class="unchanged"><span> 					return $then;</span></td></tr>
<tr id="53"><td class="linenumbers">363</td><td class="linenumbers">362</td><td class="unchanged"><span> 				} elseif ( $lc->isBadLink( $pdbk ) ) {</span></td></tr>
<tr id="54"><td class="linenumbers">364</td><td class="linenumbers">363</td><td class="unchanged"><span> 					return $else;</span></td></tr>
<tr id="55"><td class="linenumbers">365</td><td class="linenumbers">364</td><td class="unchanged"><span> 				}</span></td></tr>
<tr id="56"><td class="linenumbers">366</td><td class="linenumbers"> </td><td class="del"><del>-				if ( !$this->incrementIfexistCount( $parser, $frame ) ) {</del></td></tr>
<tr id="57"><td class="linenumbers">367</td><td class="linenumbers"> </td><td class="del"><del>-					return $else;</del></td></tr>
<tr id="58"><td class="linenumbers">368</td><td class="linenumbers"> </td><td class="del"><del>-				}</del></td></tr>
<tr id="59"><td class="linenumbers">369</td><td class="linenumbers"> </td><td class="del"><del>-</del></td></tr>
<tr id="60"><td class="linenumbers">370</td><td class="linenumbers">365</td><td class="unchanged"><span> 				$id = $title->getArticleID();</span></td></tr>
<tr id="61"><td class="linenumbers">371</td><td class="linenumbers">366</td><td class="unchanged"><span> 				$parser->mOutput->addLink( $title, $id );</span></td></tr>
<tr id="62"><td class="linenumbers">372</td><td class="linenumbers">367</td><td class="unchanged"><span> 				if ( $id ) {</span></td></tr>
<tr id="63"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -476,22 +471,6 @@</span></td></tr>
<tr id="64"><td class="linenumbers">477</td><td class="linenumbers">472</td><td class="unchanged"><span> 			return $title;</span></td></tr>
<tr id="65"><td class="linenumbers">478</td><td class="linenumbers">473</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="66"><td class="linenumbers">479</td><td class="linenumbers">474</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="67"><td class="linenumbers">480</td><td class="linenumbers"> </td><td class="del"><del>-</del></td></tr>
<tr id="68"><td class="linenumbers">481</td><td class="linenumbers"> </td><td class="del"><del>-	function afterTidy( &amp;$parser, &amp;$text ) {</del></td></tr>
<tr id="69"><td class="linenumbers">482</td><td class="linenumbers"> </td><td class="del"><del>-		global $wgMaxIfExistCount;</del></td></tr>
<tr id="70"><td class="linenumbers">483</td><td class="linenumbers"> </td><td class="del"><del>-		if ( $parser->pf_ifexist_count > $wgMaxIfExistCount ) {</del></td></tr>
<tr id="71"><td class="linenumbers">484</td><td class="linenumbers"> </td><td class="del"><del>-			if ( is_callable( array( $parser->mOutput, 'addWarning' ) ) ) {</del></td></tr>
<tr id="72"><td class="linenumbers">485</td><td class="linenumbers"> </td><td class="del"><del>-				wfLoadExtensionMessages( 'ParserFunctions' );</del></td></tr>
<tr id="73"><td class="linenumbers">486</td><td class="linenumbers"> </td><td class="del"><del>-				$warning = wfMsg( 'pfunc_ifexist_warning', $parser->pf_ifexist_count, $wgMaxIfExistCount );</del></td></tr>
<tr id="74"><td class="linenumbers">487</td><td class="linenumbers"> </td><td class="del"><del>-				$parser->mOutput->addWarning( $warning );</del></td></tr>
<tr id="75"><td class="linenumbers">488</td><td class="linenumbers"> </td><td class="del"><del>-				$cat = Title::makeTitleSafe( NS_CATEGORY, wfMsgForContent( 'pfunc_max_ifexist_category' ) );</del></td></tr>
<tr id="76"><td class="linenumbers">489</td><td class="linenumbers"> </td><td class="del"><del>-				if ( $cat ) {</del></td></tr>
<tr id="77"><td class="linenumbers">490</td><td class="linenumbers"> </td><td class="del"><del>-					$parser->mOutput->addCategory( $cat->getDBkey(), $parser->getDefaultSort() );</del></td></tr>
<tr id="78"><td class="linenumbers">491</td><td class="linenumbers"> </td><td class="del"><del>-				}</del></td></tr>
<tr id="79"><td class="linenumbers">492</td><td class="linenumbers"> </td><td class="del"><del>-			}</del></td></tr>
<tr id="80"><td class="linenumbers">493</td><td class="linenumbers"> </td><td class="del"><del>-		}</del></td></tr>
<tr id="81"><td class="linenumbers">494</td><td class="linenumbers"> </td><td class="del"><del>-		return true;</del></td></tr>
<tr id="82"><td class="linenumbers">495</td><td class="linenumbers"> </td><td class="del"><del>-	}</del></td></tr>
<tr id="83"><td class="linenumbers">496</td><td class="linenumbers">475</td><td class="unchanged"><span> }</span></td></tr>
<tr id="84"><td class="linenumbers">497</td><td class="linenumbers">476</td><td class="unchanged"><span> </span></td></tr>
<tr id="85"><td class="linenumbers">498</td><td class="linenumbers">477</td><td class="unchanged"><span> function wfSetupParserFunctions() {</span></td></tr>
<tr id="86"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -510,7 +489,6 @@</span></td></tr>
<tr id="87"><td class="linenumbers">511</td><td class="linenumbers">490</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="88"><td class="linenumbers">512</td><td class="linenumbers">491</td><td class="unchanged"><span> </span></td></tr>
<tr id="89"><td class="linenumbers">513</td><td class="linenumbers">492</td><td class="unchanged"><span> 	$wgHooks['ParserClearState'][] = array( &amp;$wgExtParserFunctions, 'clearState' );</span></td></tr>
<tr id="90"><td class="linenumbers">514</td><td class="linenumbers"> </td><td class="del"><del>-	$wgHooks['ParserAfterTidy'][] = array( &amp;$wgExtParserFunctions, 'afterTidy' );</del></td></tr>
<tr id="91"><td class="linenumbers">515</td><td class="linenumbers">493</td><td class="unchanged"><span> }</span></td></tr>
<tr id="92"><td class="linenumbers">516</td><td class="linenumbers">494</td><td class="unchanged"><span> </span></td></tr>
<tr id="93"><td class="linenumbers">517</td><td class="linenumbers">495</td><td class="unchanged"><span> function wfParserFunctionsLanguageGetMagic( &amp;$magicWords, $langCode ) {</span></td></tr>
<tr id="94"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -520,11 +498,3 @@</span></td></tr>
<tr id="95"><td class="linenumbers">521</td><td class="linenumbers">499</td><td class="unchanged"><span> 	return true;</span></td></tr>
<tr id="96"><td class="linenumbers">522</td><td class="linenumbers">500</td><td class="unchanged"><span> }</span></td></tr>
<tr id="97"><td class="linenumbers">523</td><td class="linenumbers">501</td><td class="unchanged"><span> </span></td></tr>
<tr id="98"><td class="linenumbers">524</td><td class="linenumbers"> </td><td class="del"><del>-function wfParserFunctionsLimitReport( $parser, &amp;$report ) {</del></td></tr>
<tr id="99"><td class="linenumbers">525</td><td class="linenumbers"> </td><td class="del"><del>-	global $wgMaxIfExistCount;</del></td></tr>
<tr id="100"><td class="linenumbers">526</td><td class="linenumbers"> </td><td class="del"><del>-	if ( isset( $parser->pf_ifexist_count ) ) {</del></td></tr>
<tr id="101"><td class="linenumbers">527</td><td class="linenumbers"> </td><td class="del"><del>-		$report .= "#ifexist count: {$parser->pf_ifexist_count}/$wgMaxIfExistCount\n";</del></td></tr>
<tr id="102"><td class="linenumbers">528</td><td class="linenumbers"> </td><td class="del"><del>-	}</del></td></tr>
<tr id="103"><td class="linenumbers">529</td><td class="linenumbers"> </td><td class="del"><del>-	return true;</del></td></tr>
<tr id="104"><td class="linenumbers">530</td><td class="linenumbers"> </td><td class="del"><del>-}</del></td></tr>
<tr id="105"><td class="linenumbers">531</td><td class="linenumbers"> </td><td class="del"><del>-</del></td></tr>
<tr id="106" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/Parser.php</td></tr>



<tr id="110"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -102,6 +102,7 @@</span></td></tr>
<tr id="111"><td class="linenumbers">103</td><td class="linenumbers">103</td><td class="unchanged"><span> 	var $mIncludeSizes, $mPPNodeCount, $mDefaultSort;</span></td></tr>
<tr id="112"><td class="linenumbers">104</td><td class="linenumbers">104</td><td class="unchanged"><span> 	var $mTplExpandCache; // empty-frame expansion cache</span></td></tr>
<tr id="113"><td class="linenumbers">105</td><td class="linenumbers">105</td><td class="unchanged"><span> 	var $mTplRedirCache, $mTplDomCache, $mHeadings, $mDoubleUnderscores;</span></td></tr>
<tr id="114"><td class="linenumbers"> </td><td class="linenumbers">106</td><td class="ins"><ins>+	var $mExpensiveFunctionCount; // number of expensive parser function calls</ins></td></tr>
<tr id="115"><td class="linenumbers">106</td><td class="linenumbers">107</td><td class="unchanged"><span> </span></td></tr>
<tr id="116"><td class="linenumbers">107</td><td class="linenumbers">108</td><td class="unchanged"><span> 	# Temporary</span></td></tr>
<tr id="117"><td class="linenumbers">108</td><td class="linenumbers">109</td><td class="unchanged"><span> 	# These are variables reset at least once per parse regardless of $clearState</span></td></tr>
<tr id="118"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -217,6 +218,7 @@</span></td></tr>
<tr id="119"><td class="linenumbers">218</td><td class="linenumbers">219</td><td class="unchanged"><span> 		$this->mDefaultSort = false;</span></td></tr>
<tr id="120"><td class="linenumbers">219</td><td class="linenumbers">220</td><td class="unchanged"><span> 		$this->mHeadings = array();</span></td></tr>
<tr id="121"><td class="linenumbers">220</td><td class="linenumbers">221</td><td class="unchanged"><span> 		$this->mDoubleUnderscores = array();</span></td></tr>
<tr id="122"><td class="linenumbers"> </td><td class="linenumbers">222</td><td class="ins"><ins>+		$this->mExpensiveFunctionCount = 0;</ins></td></tr>
<tr id="123"><td class="linenumbers">221</td><td class="linenumbers">223</td><td class="unchanged"><span> </span></td></tr>
<tr id="124"><td class="linenumbers">222</td><td class="linenumbers">224</td><td class="unchanged"><span> 		# Fix cloning</span></td></tr>
<tr id="125"><td class="linenumbers">223</td><td class="linenumbers">225</td><td class="unchanged"><span> 		if ( isset( $this->mPreprocessor ) &amp;&amp; $this->mPreprocessor->parser !== $this ) {</span></td></tr>
<tr id="126"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -390,17 +392,31 @@</span></td></tr>
<tr id="127"><td class="linenumbers">391</td><td class="linenumbers">393</td><td class="unchanged"><span> 				array_values( $tidyregs ),</span></td></tr>
<tr id="128"><td class="linenumbers">392</td><td class="linenumbers">394</td><td class="unchanged"><span> 				$text );</span></td></tr>
<tr id="129"><td class="linenumbers">393</td><td class="linenumbers">395</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="130"><td class="linenumbers"> </td><td class="linenumbers">396</td><td class="ins"><ins>+		global $wgExpensiveParserFunctionLimit;</ins></td></tr>
<tr id="131"><td class="linenumbers"> </td><td class="linenumbers">397</td><td class="ins"><ins>+		if ( $this->mExpensiveFunctionCount > $wgExpensiveParserFunctionLimit ) {</ins></td></tr>
<tr id="132"><td class="linenumbers"> </td><td class="linenumbers">398</td><td class="ins"><ins>+			if ( is_callable( array( $this->mOutput, 'addWarning' ) ) ) {</ins></td></tr>
<tr id="133"><td class="linenumbers"> </td><td class="linenumbers">399</td><td class="ins"><ins>+				$warning = wfMsg( 'expensive-parserfunction-warning', $this->mExpensiveFunctionCount, $wgExpensiveParserFunctionLimit );</ins></td></tr>
<tr id="134"><td class="linenumbers"> </td><td class="linenumbers">400</td><td class="ins"><ins>+				$this->mOutput->addWarning( $warning );</ins></td></tr>
<tr id="135"><td class="linenumbers"> </td><td class="linenumbers">401</td><td class="ins"><ins>+				$cat = Title::makeTitleSafe( NS_CATEGORY, wfMsgForContent( 'expensive-parserfunction-category' ) );</ins></td></tr>
<tr id="136"><td class="linenumbers"> </td><td class="linenumbers">402</td><td class="ins"><ins>+				if ( $cat ) {</ins></td></tr>
<tr id="137"><td class="linenumbers"> </td><td class="linenumbers">403</td><td class="ins"><ins>+					$this->mOutput->addCategory( $cat->getDBkey(), $this->getDefaultSort() );</ins></td></tr>
<tr id="138"><td class="linenumbers"> </td><td class="linenumbers">404</td><td class="ins"><ins>+				}</ins></td></tr>
<tr id="139"><td class="linenumbers"> </td><td class="linenumbers">405</td><td class="ins"><ins>+			}</ins></td></tr>
<tr id="140"><td class="linenumbers"> </td><td class="linenumbers">406</td><td class="ins"><ins>+		}</ins></td></tr>
<tr id="141"><td class="linenumbers">394</td><td class="linenumbers">407</td><td class="unchanged"><span> </span></td></tr>
<tr id="142"><td class="linenumbers">395</td><td class="linenumbers">408</td><td class="unchanged"><span> 		wfRunHooks( 'ParserAfterTidy', array( &amp;$this, &amp;$text ) );</span></td></tr>
<tr id="143"><td class="linenumbers">396</td><td class="linenumbers">409</td><td class="unchanged"><span> </span></td></tr>
<tr id="144"><td class="linenumbers">397</td><td class="linenumbers">410</td><td class="unchanged"><span> 		# Information on include size limits, for the benefit of users who try to skirt them</span></td></tr>
<tr id="145"><td class="linenumbers">398</td><td class="linenumbers">411</td><td class="unchanged"><span> 		if ( $this->mOptions->getEnableLimitReport() ) {</span></td></tr>
<tr id="146"><td class="linenumbers"> </td><td class="linenumbers">412</td><td class="ins"><ins>+			global $wgExpensiveParserFunctionLimit;</ins></td></tr>
<tr id="147"><td class="linenumbers">399</td><td class="linenumbers">413</td><td class="unchanged"><span> 			$max = $this->mOptions->getMaxIncludeSize();</span></td></tr>
<tr id="148"><td class="linenumbers"> </td><td class="linenumbers">414</td><td class="ins"><ins>+			$PFreport = "Expensive parser function count: {$this->mExpensiveFunctionCount}/$wgExpensiveParserFunctionLimit\n";</ins></td></tr>
<tr id="149"><td class="linenumbers">400</td><td class="linenumbers">415</td><td class="unchanged"><span> 			$limitReport = </span></td></tr>
<tr id="150"><td class="linenumbers">401</td><td class="linenumbers">416</td><td class="unchanged"><span> 				"NewPP limit report\n" . </span></td></tr>
<tr id="151"><td class="linenumbers">402</td><td class="linenumbers">417</td><td class="unchanged"><span> 				"Preprocessor node count: {$this->mPPNodeCount}/{$this->mOptions->mMaxPPNodeCount}\n" .</span></td></tr>
<tr id="152"><td class="linenumbers">403</td><td class="linenumbers">418</td><td class="unchanged"><span> 				"Post-expand include size: {$this->mIncludeSizes['post-expand']}/$max bytes\n" .</span></td></tr>
<tr id="153"><td class="linenumbers">404</td><td class="linenumbers"> </td><td class="del"><del>-				"Template argument size: {$this->mIncludeSizes['arg']}/$max bytes\n";</del></td></tr>
<tr id="154"><td class="linenumbers"> </td><td class="linenumbers">419</td><td class="ins"><ins>+				"Template argument size: {$this->mIncludeSizes['arg']}/$max bytes\n".</ins></td></tr>
<tr id="155"><td class="linenumbers"> </td><td class="linenumbers">420</td><td class="ins"><ins>+				$PFreport;</ins></td></tr>
<tr id="156"><td class="linenumbers">405</td><td class="linenumbers">421</td><td class="unchanged"><span> 			wfRunHooks( 'ParserLimitReport', array( $this, &amp;$limitReport ) );</span></td></tr>
<tr id="157"><td class="linenumbers">406</td><td class="linenumbers">422</td><td class="unchanged"><span> 			$text .= "\n&lt;!-- \n$limitReport-->\n";</span></td></tr>
<tr id="158"><td class="linenumbers">407</td><td class="linenumbers">423</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="159" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/MagicWord.php</td></tr>



<tr id="163"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -102,6 +102,7 @@</span></td></tr>
<tr id="164"><td class="linenumbers">103</td><td class="linenumbers">103</td><td class="unchanged"><span> 		'pagesinnamespace',</span></td></tr>
<tr id="165"><td class="linenumbers">104</td><td class="linenumbers">104</td><td class="unchanged"><span> 		'numberofadmins',</span></td></tr>
<tr id="166"><td class="linenumbers">105</td><td class="linenumbers">105</td><td class="unchanged"><span> 		'defaultsort',</span></td></tr>
<tr id="167"><td class="linenumbers"> </td><td class="linenumbers">106</td><td class="ins"><ins>+		'pagesincategory',</ins></td></tr>
<tr id="168"><td class="linenumbers">106</td><td class="linenumbers">107</td><td class="unchanged"><span> 	);</span></td></tr>
<tr id="169"><td class="linenumbers">107</td><td class="linenumbers">108</td><td class="unchanged"><span> 	</span></td></tr>
<tr id="170"><td class="linenumbers">108</td><td class="linenumbers">109</td><td class="unchanged"><span> 	/* Array of caching hints for ParserCache */</span></td></tr>
<tr id="171" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/DefaultSettings.php</td></tr>



<tr id="175"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -3011,3 +3011,9 @@</span></td></tr>
<tr id="176"><td class="linenumbers">3012</td><td class="linenumbers">3012</td><td class="unchanged"><span>  * Special:Whatlinkshere/RedirectDestination</span></td></tr>
<tr id="177"><td class="linenumbers">3013</td><td class="linenumbers">3013</td><td class="unchanged"><span>  */</span></td></tr>
<tr id="178"><td class="linenumbers">3014</td><td class="linenumbers">3014</td><td class="unchanged"><span> $wgMaxRedirectLinksRetrieved = 500;</span></td></tr>
<tr id="179"><td class="linenumbers"> </td><td class="linenumbers">3015</td><td class="ins"><ins>+</ins></td></tr>
<tr id="180"><td class="linenumbers"> </td><td class="linenumbers">3016</td><td class="ins"><ins>+/**</ins></td></tr>
<tr id="181"><td class="linenumbers"> </td><td class="linenumbers">3017</td><td class="ins"><ins>+* Maximum number of calls to expensive parser functions</ins></td></tr>
<tr id="182"><td class="linenumbers"> </td><td class="linenumbers">3018</td><td class="ins"><ins>+* such as PAGESINCATEGORY.</ins></td></tr>
<tr id="183"><td class="linenumbers"> </td><td class="linenumbers">3019</td><td class="ins"><ins>+*/</ins></td></tr>
<tr id="184"><td class="linenumbers"> </td><td class="linenumbers">3020</td><td class="ins"><ins>+$wgExpensiveParserFunctionLimit = 100;</ins></td></tr>
<tr id="185" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/CoreParserFunctions.php</td></tr>



<tr id="189"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -41,6 +41,7 @@</span></td></tr>
<tr id="190"><td class="linenumbers">42</td><td class="linenumbers">42</td><td class="unchanged"><span> 		$parser->setFunctionHook( 'special',          array( __CLASS__, 'special'          ) );</span></td></tr>
<tr id="191"><td class="linenumbers">43</td><td class="linenumbers">43</td><td class="unchanged"><span> 		$parser->setFunctionHook( 'defaultsort',      array( __CLASS__, 'defaultsort'      ), SFH_NO_HASH );</span></td></tr>
<tr id="192"><td class="linenumbers">44</td><td class="linenumbers">44</td><td class="unchanged"><span> 		$parser->setFunctionHook( 'filepath',         array( __CLASS__, 'filepath'         ), SFH_NO_HASH );</span></td></tr>
<tr id="193"><td class="linenumbers"> </td><td class="linenumbers">45</td><td class="ins"><ins>+		$parser->setFunctionHook( 'pagesincategory',  array( __CLASS__, 'pagesincategory'  ), SFH_NO_HASH );</ins></td></tr>
<tr id="194"><td class="linenumbers">45</td><td class="linenumbers">46</td><td class="unchanged"><span> 		$parser->setFunctionHook( 'tag',              array( __CLASS__, 'tagObj'           ), SFH_OBJECT_ARGS );</span></td></tr>
<tr id="195"><td class="linenumbers">46</td><td class="linenumbers">47</td><td class="unchanged"><span> </span></td></tr>
<tr id="196"><td class="linenumbers">47</td><td class="linenumbers">48</td><td class="unchanged"><span> 		if ( $wgAllowDisplayTitle ) {</span></td></tr>
<tr id="197"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -214,6 +215,23 @@</span></td></tr>
<tr id="198"><td class="linenumbers">215</td><td class="linenumbers">216</td><td class="unchanged"><span> 	static function pagesinnamespace( $parser, $namespace = 0, $raw = null ) {</span></td></tr>
<tr id="199"><td class="linenumbers">216</td><td class="linenumbers">217</td><td class="unchanged"><span> 		return self::formatRaw( SiteStats::pagesInNs( intval( $namespace ) ), $raw );</span></td></tr>
<tr id="200"><td class="linenumbers">217</td><td class="linenumbers">218</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="201"><td class="linenumbers"> </td><td class="linenumbers">219</td><td class="ins"><ins>+	</ins></td></tr>
<tr id="202"><td class="linenumbers"> </td><td class="linenumbers">220</td><td class="ins"><ins>+	static function pagesincategory( $parser, $category = '', $raw = null ) {</ins></td></tr>
<tr id="203"><td class="linenumbers"> </td><td class="linenumbers">221</td><td class="ins"><ins>+		global $wgExpensiveParserFunctionLimit;</ins></td></tr>
<tr id="204"><td class="linenumbers"> </td><td class="linenumbers">222</td><td class="ins"><ins>+		if ($category == '') {</ins></td></tr>
<tr id="205"><td class="linenumbers"> </td><td class="linenumbers">223</td><td class="ins"><ins>+			return 0;</ins></td></tr>
<tr id="206"><td class="linenumbers"> </td><td class="linenumbers">224</td><td class="ins"><ins>+		}</ins></td></tr>
<tr id="207"><td class="linenumbers"> </td><td class="linenumbers">225</td><td class="ins"><ins>+		$parser->mExpensiveFunctionCount++;</ins></td></tr>
<tr id="208"><td class="linenumbers"> </td><td class="linenumbers">226</td><td class="ins"><ins>+		if ($parser->mExpensiveFunctionCount &lt;= $wgExpensiveParserFunctionLimit) {</ins></td></tr>
<tr id="209"><td class="linenumbers"> </td><td class="linenumbers">227</td><td class="ins"><ins>+			$category = Category::newFromName($category);</ins></td></tr>
<tr id="210"><td class="linenumbers"> </td><td class="linenumbers">228</td><td class="ins"><ins>+			$count = $category->getPageCount();</ins></td></tr>
<tr id="211"><td class="linenumbers"> </td><td class="linenumbers">229</td><td class="ins"><ins>+			if ( !$count ) {</ins></td></tr>
<tr id="212"><td class="linenumbers"> </td><td class="linenumbers">230</td><td class="ins"><ins>+				$count = 0;</ins></td></tr>
<tr id="213"><td class="linenumbers"> </td><td class="linenumbers">231</td><td class="ins"><ins>+			}</ins></td></tr>
<tr id="214"><td class="linenumbers"> </td><td class="linenumbers">232</td><td class="ins"><ins>+			return self::formatRaw( $count, $raw );</ins></td></tr>
<tr id="215"><td class="linenumbers"> </td><td class="linenumbers">233</td><td class="ins"><ins>+		}</ins></td></tr>
<tr id="216"><td class="linenumbers"> </td><td class="linenumbers">234</td><td class="ins"><ins>+		return 0;</ins></td></tr>
<tr id="217"><td class="linenumbers"> </td><td class="linenumbers">235</td><td class="ins"><ins>+	}</ins></td></tr>
<tr id="218"><td class="linenumbers">218</td><td class="linenumbers">236</td><td class="unchanged"><span> </span></td></tr>
<tr id="219"><td class="linenumbers">219</td><td class="linenumbers">237</td><td class="unchanged"><span> 	static function language( $parser, $arg = '' ) {</span></td></tr>
<tr id="220"><td class="linenumbers">220</td><td class="linenumbers">238</td><td class="unchanged"><span> 		global $wgContLang;</span></td></tr>
<tr id="221" class="patchedfile"><td colspan="3">Index: trunk/phase3/languages/messages/MessagesEn.php</td></tr>



<tr id="225"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -338,6 +338,7 @@</span></td></tr>
<tr id="226"><td class="linenumbers">339</td><td class="linenumbers">339</td><td class="unchanged"><span> 	'filepath'               => array( 0,    'FILEPATH:'              ),</span></td></tr>
<tr id="227"><td class="linenumbers">340</td><td class="linenumbers">340</td><td class="unchanged"><span> 	'tag'                    => array( 0,    'tag'                    ),</span></td></tr>
<tr id="228"><td class="linenumbers">341</td><td class="linenumbers">341</td><td class="unchanged"><span> 	'hiddencat'              => array( 1,    '__HIDDENCAT__'          ),</span></td></tr>
<tr id="229"><td class="linenumbers"> </td><td class="linenumbers">342</td><td class="ins"><ins>+	'pagesincategory'        => array( 1,    'PAGESINCATEGORY', 'PAGESINCAT' ),</ins></td></tr>
<tr id="230"><td class="linenumbers">342</td><td class="linenumbers">343</td><td class="unchanged"><span> );</span></td></tr>
<tr id="231"><td class="linenumbers">343</td><td class="linenumbers">344</td><td class="unchanged"><span> </span></td></tr>
<tr id="232"><td class="linenumbers">344</td><td class="linenumbers">345</td><td class="unchanged"><span> /**</span></td></tr>
<tr id="233"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -1128,7 +1129,11 @@</span></td></tr>
<tr id="234"><td class="linenumbers">1129</td><td class="linenumbers">1130</td><td class="unchanged"><span> </span></td></tr>
<tr id="235"><td class="linenumbers">1130</td><td class="linenumbers">1131</td><td class="unchanged"><span> You should consider whether it is appropriate to continue editing this page.</span></td></tr>
<tr id="236"><td class="linenumbers">1131</td><td class="linenumbers">1132</td><td class="unchanged"><span> The deletion log for this page is provided here for convenience:",</span></td></tr>
<tr id="237"><td class="linenumbers"> </td><td class="linenumbers">1133</td><td class="ins"><ins>+'expensive-parserfunction-warning'  => 'Warning: This page contains too many expensive parser function calls.</ins></td></tr>
<tr id="238"><td class="linenumbers">1132</td><td class="linenumbers">1134</td><td class="unchanged"><span> </span></td></tr>
<tr id="239"><td class="linenumbers"> </td><td class="linenumbers">1135</td><td class="ins"><ins>+It should have less than $2, there are now $1.',</ins></td></tr>
<tr id="240"><td class="linenumbers"> </td><td class="linenumbers">1136</td><td class="ins"><ins>+'expensive-parserfunction-category' => 'Pages with too many expensive parser function calls',</ins></td></tr>
<tr id="241"><td class="linenumbers"> </td><td class="linenumbers">1137</td><td class="ins"><ins>+</ins></td></tr>
<tr id="242"><td class="linenumbers">1133</td><td class="linenumbers">1138</td><td class="unchanged"><span> # "Undo" feature</span></td></tr>
<tr id="243"><td class="linenumbers">1134</td><td class="linenumbers">1139</td><td class="unchanged"><span> 'undo-success' => 'The edit can be undone. Please check the comparison below to verify that this is what you want to do, and then save the changes below to finish undoing the edit.',</span></td></tr>
<tr id="244"><td class="linenumbers">1135</td><td class="linenumbers">1140</td><td class="unchanged"><span> 'undo-failure' => 'The edit could not be undone due to conflicting intermediate edits.',</span></td></tr>
<tr id="245" class="patchedfile"><td colspan="3">Index: trunk/phase3/RELEASE-NOTES</td></tr>



<tr id="249"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -65,7 +65,9 @@</span></td></tr>
<tr id="250"><td class="linenumbers">66</td><td class="linenumbers">66</td><td class="unchanged"><span> * Redesign of Special:Userrights</span></td></tr>
<tr id="251"><td class="linenumbers">67</td><td class="linenumbers">67</td><td class="unchanged"><span> * Make rev_deleted log entries more intelligible.</span></td></tr>
<tr id="252"><td class="linenumbers">68</td><td class="linenumbers">68</td><td class="unchanged"><span> * Logs are grouped under date headings similar to enhanced changes list</span></td></tr>
<tr id="253"><td class="linenumbers"> </td><td class="linenumbers">69</td><td class="ins"><ins>+* (6943) Added PAGESINCATEGORY: magic word</ins></td></tr>
<tr id="254"><td class="linenumbers">69</td><td class="linenumbers">70</td><td class="unchanged"><span> </span></td></tr>
<tr id="255"><td class="linenumbers"> </td><td class="linenumbers">71</td><td class="ins"><ins>+</ins></td></tr>
<tr id="256"><td class="linenumbers">70</td><td class="linenumbers">72</td><td class="unchanged"><span> === Bug fixes in 1.13 ===</span></td></tr>
<tr id="257"><td class="linenumbers">71</td><td class="linenumbers">73</td><td class="unchanged"><span> </span></td></tr>
<tr id="258"><td class="linenumbers">72</td><td class="linenumbers">74</td><td class="unchanged"><span> * (bug 10677) Add link to the file description page on the shared repository</span></td></tr>
</table>
</div>
<h2 id='code-references'>Follow-up revisions</h2>
<table border='1' class='wikitable'><tr><th>Revision</th><th>Commit summary</th><th>Author</th><th>Date</th></tr><tr class='mw-codereview-status-old'><td><a href="./32965.html" title="Special:Code/MediaWiki/32965">r32965</a></td><td>* (<a class="external" href="https://bugzilla.wikimedia.org/show_bug.cgi?id=13657">Bug 13657</a>) Remove unused ParserFunctions messages (<a href="./32932.html" title="Special:Code/MediaWiki/32932">r32932</a>)</td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki/author/raymond" title="Special:Code/MediaWiki/author/raymond">raymond</a></td><td>16:00, 8 April 2008</td></tr></table><h2 id='code-changes'>Status &amp; tagging log</h2>
<ul class='mw-codereview-changes'><li>15:25, 12 September 2011&#160;<a href="https://www.mediawiki.org/wiki/User:Meno25" class="mw-userlink" title="User:Meno25"><bdi>Meno25</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Meno25" class="mw-usertoollinks-talk" title="User talk:Meno25">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Meno25" class="mw-usertoollinks-contribs" title="Special:Contributions/Meno25">contribs</a>)</span>&#160;changed the <b>status</b> of r32932 <i>[<b>removed:</b> ok&#160;<b>added:</b> old]</i></li></ul></form></div>
</body>
</html>
 contentType 9 text/html url 64 https://static-codereview.wikimedia.org:443/MediaWiki/32932.html responseCode 3 200 