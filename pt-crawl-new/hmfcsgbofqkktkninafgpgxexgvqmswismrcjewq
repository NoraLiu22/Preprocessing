hmfcsgbofqkktkninafgpgxexgvqmswismrcjewq length 5 43616 page 43616 
<html>
<head>
<title>r48249 MediaWiki - Code Review archive</title>
<meta charset="utf-8">
<link rel="stylesheet" href="../ext.codereview.styles.css"/>
</head>
<body>
<h1>r48249 MediaWiki - Code Review archive</h1>
<div id="mw-content-text" class="mw-body-content"><form action="/wiki/Special:Code/MediaWiki/48249" method="post"><table class="mw-codereview-meta"><tr><td>Repository:</td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki" title="Special:Code/MediaWiki">MediaWiki</a></td></tr>
<tr><td>Revision:</td><td>&lt;&#160;<a href="./48248.html" title="Special:Code/MediaWiki/48248">r48248</a>‎ | <b>r48249</b> | <a href="./48250.html" title="Special:Code/MediaWiki/48250">r48250</a>&#160;&gt;</td></tr>
<tr><td>Date:</td><td>01:07, 10 March 2009</td></tr>
<tr><td>Author:</td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki/author/werdna" title="Special:Code/MediaWiki/author/werdna">werdna</a></td></tr>
<tr><td>Status:</td><td>resolved (<a href="#code-comments">Comments</a>)
</td></tr>
<tr><td>Tags:</td><td></td></tr>
<tr><td>Comment:</td><td><div class="mw-codereview-message">* (<a class="external" href="https://bugzilla.wikimedia.org/show_bug.cgi?id=4582">bug 4582</a>) Provide preference-based autoformatting of unlinked dates with the dateformat<br />
  parser function.</div></td></tr>
<tr><td>Modified paths:</td><td><div class='mw-codereview-paths mw-content-ltr'><ul>
<li><b>/trunk/phase3/includes/parser/CoreParserFunctions.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2Fparser%2FCoreParserFunctions.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/includes/parser/DateFormatter.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2Fparser%2FDateFormatter.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/languages/messages/MessagesEn.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Flanguages%2Fmessages%2FMessagesEn.php" title="Special:Code/MediaWiki">history</a>)</li>
</ul></div>
</td></tr>
</table>
<h2>Diff <small>[<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki/48249&amp;action=purge" title="Special:Code/MediaWiki/48249">purge</a>]</small></h2><div class='mw-codereview-diff' id='mw-codereview-diff'><table class="mw-codereview-diff"><tr id="1" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/parser/CoreParserFunctions.php</td></tr>



<tr id="5"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -67,6 +67,7 @@</span></td></tr>
<tr id="6"><td class="linenumbers">68</td><td class="linenumbers">68</td><td class="unchanged"><span> 		$parser->setFunctionHook( 'subjectpagename',  array( __CLASS__, 'subjectpagename'  ), SFH_NO_HASH );</span></td></tr>
<tr id="7"><td class="linenumbers">69</td><td class="linenumbers">69</td><td class="unchanged"><span> 		$parser->setFunctionHook( 'subjectpagenamee', array( __CLASS__, 'subjectpagenamee' ), SFH_NO_HASH );</span></td></tr>
<tr id="8"><td class="linenumbers">70</td><td class="linenumbers">70</td><td class="unchanged"><span> 		$parser->setFunctionHook( 'tag',              array( __CLASS__, 'tagObj'           ), SFH_OBJECT_ARGS );</span></td></tr>
<tr id="9"><td class="linenumbers"> </td><td class="linenumbers">71</td><td class="ins"><ins>+		$parser->setFunctionHook( 'formatdate',		  array( __CLASS__, 'formatDate'	   ), SFH_NO_HASH );</ins></td></tr>
<tr id="10"><td class="linenumbers">71</td><td class="linenumbers">72</td><td class="unchanged"><span> </span></td></tr>
<tr id="11"><td class="linenumbers">72</td><td class="linenumbers">73</td><td class="unchanged"><span> 		if ( $wgAllowDisplayTitle ) {</span></td></tr>
<tr id="12"><td class="linenumbers">73</td><td class="linenumbers">74</td><td class="unchanged"><span> 			$parser->setFunctionHook( 'displaytitle', array( __CLASS__, 'displaytitle' ), SFH_NO_HASH );</span></td></tr>
<tr id="13"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -87,6 +88,14 @@</span></td></tr>
<tr id="14"><td class="linenumbers">88</td><td class="linenumbers">89</td><td class="unchanged"><span> 			return array( 'found' => false );</span></td></tr>
<tr id="15"><td class="linenumbers">89</td><td class="linenumbers">90</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="16"><td class="linenumbers">90</td><td class="linenumbers">91</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="17"><td class="linenumbers"> </td><td class="linenumbers">92</td><td class="ins"><ins>+	</ins></td></tr>
<tr id="18"><td class="linenumbers"> </td><td class="linenumbers">93</td><td class="ins"><ins>+	static function formatDate( $parser, $date ) {</ins></td></tr>
<tr id="19"><td class="linenumbers"> </td><td class="linenumbers">94</td><td class="ins"><ins>+		$df = DateFormatter::getInstance();</ins></td></tr>
<tr id="20"><td class="linenumbers"> </td><td class="linenumbers">95</td><td class="ins"><ins>+		</ins></td></tr>
<tr id="21"><td class="linenumbers"> </td><td class="linenumbers">96</td><td class="ins"><ins>+		$pref = $parser->mOptions->getDateFormat();</ins></td></tr>
<tr id="22"><td class="linenumbers"> </td><td class="linenumbers">97</td><td class="ins"><ins>+		$date = $df->reformat( $pref, $date, false );</ins></td></tr>
<tr id="23"><td class="linenumbers"> </td><td class="linenumbers">98</td><td class="ins"><ins>+		return $date;</ins></td></tr>
<tr id="24"><td class="linenumbers"> </td><td class="linenumbers">99</td><td class="ins"><ins>+	}</ins></td></tr>
<tr id="25"><td class="linenumbers">91</td><td class="linenumbers">100</td><td class="unchanged"><span> </span></td></tr>
<tr id="26"><td class="linenumbers">92</td><td class="linenumbers">101</td><td class="unchanged"><span> 	static function ns( $parser, $part1 = '' ) {</span></td></tr>
<tr id="27"><td class="linenumbers">93</td><td class="linenumbers">102</td><td class="unchanged"><span> 		global $wgContLang;</span></td></tr>
<tr id="28" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/parser/DateFormatter.php</td></tr>



<tr id="32"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -41,11 +41,11 @@</span></td></tr>
<tr id="33"><td class="linenumbers">42</td><td class="linenumbers">42</td><td class="unchanged"><span> 		$this->regexTrail = '(?![a-z])/iu';</span></td></tr>
<tr id="34"><td class="linenumbers">43</td><td class="linenumbers">43</td><td class="unchanged"><span> </span></td></tr>
<tr id="35"><td class="linenumbers">44</td><td class="linenumbers">44</td><td class="unchanged"><span> 		# Partial regular expressions</span></td></tr>
<tr id="36"><td class="linenumbers">45</td><td class="linenumbers"> </td><td class="del"><del>-		$this->prxDM = '\[\[(\d{1,2})[ _](' . $this->monthNames . ')]]';</del></td></tr>
<tr id="37"><td class="linenumbers">46</td><td class="linenumbers"> </td><td class="del"><del>-		$this->prxMD = '\[\[(' . $this->monthNames . ')[ _](\d{1,2})]]';</del></td></tr>
<tr id="38"><td class="linenumbers">47</td><td class="linenumbers"> </td><td class="del"><del>-		$this->prxY = '\[\[(\d{1,4}([ _]BC|))]]';</del></td></tr>
<tr id="39"><td class="linenumbers">48</td><td class="linenumbers"> </td><td class="del"><del>-		$this->prxISO1 = '\[\[(-?\d{4})]]-\[\[(\d{2})-(\d{2})]]';</del></td></tr>
<tr id="40"><td class="linenumbers">49</td><td class="linenumbers"> </td><td class="del"><del>-		$this->prxISO2 = '\[\[(-?\d{4})-(\d{2})-(\d{2})]]';</del></td></tr>
<tr id="41"><td class="linenumbers"> </td><td class="linenumbers">45</td><td class="ins"><ins>+		$this->prxDM = '\[\[(\d{1,2})[ _](' . $this->monthNames . ')\]\]';</ins></td></tr>
<tr id="42"><td class="linenumbers"> </td><td class="linenumbers">46</td><td class="ins"><ins>+		$this->prxMD = '\[\[(' . $this->monthNames . ')[ _](\d{1,2})\]\]';</ins></td></tr>
<tr id="43"><td class="linenumbers"> </td><td class="linenumbers">47</td><td class="ins"><ins>+		$this->prxY = '\[\[(\d{1,4}([ _]BC|))\]\]';</ins></td></tr>
<tr id="44"><td class="linenumbers"> </td><td class="linenumbers">48</td><td class="ins"><ins>+		$this->prxISO1 = '\[\[(-?\d{4})]]-\[\[(\d{2})-(\d{2})\]\]';</ins></td></tr>
<tr id="45"><td class="linenumbers"> </td><td class="linenumbers">49</td><td class="ins"><ins>+		$this->prxISO2 = '\[\[(-?\d{4})-(\d{2})-(\d{2})\]\]';</ins></td></tr>
<tr id="46"><td class="linenumbers">50</td><td class="linenumbers">50</td><td class="unchanged"><span> </span></td></tr>
<tr id="47"><td class="linenumbers">51</td><td class="linenumbers">51</td><td class="unchanged"><span> 		# Real regular expressions</span></td></tr>
<tr id="48"><td class="linenumbers">52</td><td class="linenumbers">52</td><td class="unchanged"><span> 		$this->regexes[self::DMY] = "/{$this->prxDM} *,? *{$this->prxY}{$this->regexTrail}";</span></td></tr>
<tr id="49"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -117,7 +117,7 @@</span></td></tr>
<tr id="50"><td class="linenumbers">118</td><td class="linenumbers">118</td><td class="unchanged"><span> 	 * @param $preference String: User preference</span></td></tr>
<tr id="51"><td class="linenumbers">119</td><td class="linenumbers">119</td><td class="unchanged"><span> 	 * @param $text String: Text to reformat</span></td></tr>
<tr id="52"><td class="linenumbers">120</td><td class="linenumbers">120</td><td class="unchanged"><span> 	 */</span></td></tr>
<tr id="53"><td class="linenumbers">121</td><td class="linenumbers"> </td><td class="del"><del>-	function reformat( $preference, $text ) {</del></td></tr>
<tr id="54"><td class="linenumbers"> </td><td class="linenumbers">121</td><td class="ins"><ins>+	function reformat( $preference, $text, $linked = true ) {</ins></td></tr>
<tr id="55"><td class="linenumbers">122</td><td class="linenumbers">122</td><td class="unchanged"><span> 		if ( isset( $this->preferences[$preference] ) ) {</span></td></tr>
<tr id="56"><td class="linenumbers">123</td><td class="linenumbers">123</td><td class="unchanged"><span> 			$preference = $this->preferences[$preference];</span></td></tr>
<tr id="57"><td class="linenumbers">124</td><td class="linenumbers">124</td><td class="unchanged"><span> 		} else {</span></td></tr>
<tr id="58"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -138,7 +138,17 @@</span></td></tr>
<tr id="59"><td class="linenumbers">139</td><td class="linenumbers">139</td><td class="unchanged"><span> 				# Default</span></td></tr>
<tr id="60"><td class="linenumbers">140</td><td class="linenumbers">140</td><td class="unchanged"><span> 				$this->mTarget = $i;</span></td></tr>
<tr id="61"><td class="linenumbers">141</td><td class="linenumbers">141</td><td class="unchanged"><span> 			}</span></td></tr>
<tr id="62"><td class="linenumbers">142</td><td class="linenumbers"> </td><td class="del"><del>-			$text = preg_replace_callback( $this->regexes[$i], array( &amp;$this, 'replace' ), $text );</del></td></tr>
<tr id="63"><td class="linenumbers"> </td><td class="linenumbers">142</td><td class="ins"><ins>+			$regex = $this->regexes[$i];</ins></td></tr>
<tr id="64"><td class="linenumbers"> </td><td class="linenumbers">143</td><td class="ins"><ins>+			</ins></td></tr>
<tr id="65"><td class="linenumbers"> </td><td class="linenumbers">144</td><td class="ins"><ins>+			// Horrible hack</ins></td></tr>
<tr id="66"><td class="linenumbers"> </td><td class="linenumbers">145</td><td class="ins"><ins>+			if (!$linked) {</ins></td></tr>
<tr id="67"><td class="linenumbers"> </td><td class="linenumbers">146</td><td class="ins"><ins>+				$regex = str_replace( array( '\[\[', '\]\]' ), '', $regex );</ins></td></tr>
<tr id="68"><td class="linenumbers"> </td><td class="linenumbers">147</td><td class="ins"><ins>+			}</ins></td></tr>
<tr id="69"><td class="linenumbers"> </td><td class="linenumbers">148</td><td class="ins"><ins>+			</ins></td></tr>
<tr id="70"><td class="linenumbers"> </td><td class="linenumbers">149</td><td class="ins"><ins>+			// Another horrible hack</ins></td></tr>
<tr id="71"><td class="linenumbers"> </td><td class="linenumbers">150</td><td class="ins"><ins>+			$this->mLinked = $linked;</ins></td></tr>
<tr id="72"><td class="linenumbers"> </td><td class="linenumbers">151</td><td class="ins"><ins>+			$text = preg_replace_callback( $regex, array( &amp;$this, 'replace' ), $text );</ins></td></tr>
<tr id="73"><td class="linenumbers"> </td><td class="linenumbers">152</td><td class="ins"><ins>+			unset($this->mLinked);</ins></td></tr>
<tr id="74"><td class="linenumbers">143</td><td class="linenumbers">153</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="75"><td class="linenumbers">144</td><td class="linenumbers">154</td><td class="unchanged"><span> 		return $text;</span></td></tr>
<tr id="76"><td class="linenumbers">145</td><td class="linenumbers">155</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="77"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -148,6 +158,10 @@</span></td></tr>
<tr id="78"><td class="linenumbers">149</td><td class="linenumbers">159</td><td class="unchanged"><span> 	 */</span></td></tr>
<tr id="79"><td class="linenumbers">150</td><td class="linenumbers">160</td><td class="unchanged"><span> 	function replace( $matches ) {</span></td></tr>
<tr id="80"><td class="linenumbers">151</td><td class="linenumbers">161</td><td class="unchanged"><span> 		# Extract information from $matches</span></td></tr>
<tr id="81"><td class="linenumbers"> </td><td class="linenumbers">162</td><td class="ins"><ins>+		$linked = true;</ins></td></tr>
<tr id="82"><td class="linenumbers"> </td><td class="linenumbers">163</td><td class="ins"><ins>+		if ( isset( $this->mLinked ) )</ins></td></tr>
<tr id="83"><td class="linenumbers"> </td><td class="linenumbers">164</td><td class="ins"><ins>+			$linked = $this->mLinked;</ins></td></tr>
<tr id="84"><td class="linenumbers"> </td><td class="linenumbers">165</td><td class="ins"><ins>+		</ins></td></tr>
<tr id="85"><td class="linenumbers">152</td><td class="linenumbers">166</td><td class="unchanged"><span> 		$bits = array();</span></td></tr>
<tr id="86"><td class="linenumbers">153</td><td class="linenumbers">167</td><td class="unchanged"><span> 		$key = $this->keys[$this->mSource];</span></td></tr>
<tr id="87"><td class="linenumbers">154</td><td class="linenumbers">168</td><td class="unchanged"><span> 		for ( $p=0; $p &lt; strlen($key); $p++ ) {</span></td></tr>
<tr id="88"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -156,43 +170,50 @@</span></td></tr>
<tr id="89"><td class="linenumbers">157</td><td class="linenumbers">171</td><td class="unchanged"><span> 			}</span></td></tr>
<tr id="90"><td class="linenumbers">158</td><td class="linenumbers">172</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="91"><td class="linenumbers">159</td><td class="linenumbers">173</td><td class="unchanged"><span> 		</span></td></tr>
<tr id="92"><td class="linenumbers">160</td><td class="linenumbers"> </td><td class="del"><del>-		return $this->formatDate( $bits );</del></td></tr>
<tr id="93"><td class="linenumbers"> </td><td class="linenumbers">174</td><td class="ins"><ins>+		return $this->formatDate( $bits, $linked );</ins></td></tr>
<tr id="94"><td class="linenumbers">161</td><td class="linenumbers">175</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="95"><td class="linenumbers">162</td><td class="linenumbers">176</td><td class="unchanged"><span> 	</span></td></tr>
<tr id="96"><td class="linenumbers">163</td><td class="linenumbers"> </td><td class="del"><del>-	function formatDate( $bits ) {</del></td></tr>
<tr id="97"><td class="linenumbers"> </td><td class="linenumbers">177</td><td class="ins"><ins>+	function formatDate( $bits, $link = true ) {</ins></td></tr>
<tr id="98"><td class="linenumbers">164</td><td class="linenumbers">178</td><td class="unchanged"><span> 		$format = $this->targets[$this->mTarget];</span></td></tr>
<tr id="99"><td class="linenumbers"> </td><td class="linenumbers">179</td><td class="ins"><ins>+		</ins></td></tr>
<tr id="100"><td class="linenumbers"> </td><td class="linenumbers">180</td><td class="ins"><ins>+		if (!$link) {</ins></td></tr>
<tr id="101"><td class="linenumbers"> </td><td class="linenumbers">181</td><td class="ins"><ins>+			// strip piped links</ins></td></tr>
<tr id="102"><td class="linenumbers"> </td><td class="linenumbers">182</td><td class="ins"><ins>+			$format = preg_replace( '/\[\[[^|]+\|([^\]]+)\]\]/', '$1', $format );</ins></td></tr>
<tr id="103"><td class="linenumbers"> </td><td class="linenumbers">183</td><td class="ins"><ins>+			// strip remaining links</ins></td></tr>
<tr id="104"><td class="linenumbers"> </td><td class="linenumbers">184</td><td class="ins"><ins>+			$format = str_replace( array( '[[', ']]' ), '', $format );</ins></td></tr>
<tr id="105"><td class="linenumbers"> </td><td class="linenumbers">185</td><td class="ins"><ins>+		}</ins></td></tr>
<tr id="106"><td class="linenumbers">165</td><td class="linenumbers">186</td><td class="unchanged"><span> </span></td></tr>
<tr id="107"><td class="linenumbers">166</td><td class="linenumbers">187</td><td class="unchanged"><span> 		# Construct new date</span></td></tr>
<tr id="108"><td class="linenumbers">167</td><td class="linenumbers">188</td><td class="unchanged"><span> 		$text = '';</span></td></tr>
<tr id="109"><td class="linenumbers">168</td><td class="linenumbers">189</td><td class="unchanged"><span> 		$fail = false;</span></td></tr>
<tr id="110"><td class="linenumbers">169</td><td class="linenumbers">190</td><td class="unchanged"><span> 		</span></td></tr>
<tr id="111"><td class="linenumbers">170</td><td class="linenumbers">191</td><td class="unchanged"><span> 		// Pre-generate y/Y stuff because we need the year for the &lt;span> title.</span></td></tr>
<tr id="112"><td class="linenumbers">171</td><td class="linenumbers"> </td><td class="del"><del>-		if ( !isset( $bits['y'] ) )</del></td></tr>
<tr id="113"><td class="linenumbers"> </td><td class="linenumbers">192</td><td class="ins"><ins>+		if ( !isset( $bits['y'] ) &amp;&amp; isset( $bits['Y'] ) )</ins></td></tr>
<tr id="114"><td class="linenumbers">172</td><td class="linenumbers">193</td><td class="unchanged"><span> 			$bits['y'] = $this->makeIsoYear( $bits['Y'] );</span></td></tr>
<tr id="115"><td class="linenumbers">173</td><td class="linenumbers"> </td><td class="del"><del>-		if ( !isset( $bits['Y'] ) )</del></td></tr>
<tr id="116"><td class="linenumbers"> </td><td class="linenumbers">194</td><td class="ins"><ins>+		if ( !isset( $bits['Y'] ) &amp;&amp; isset( $bits['y'] ) )</ins></td></tr>
<tr id="117"><td class="linenumbers">174</td><td class="linenumbers">195</td><td class="unchanged"><span> 			$bits['Y'] = $this->makeNormalYear( $bits['y'] );</span></td></tr>
<tr id="118"><td class="linenumbers"> </td><td class="linenumbers">196</td><td class="ins"><ins>+			</ins></td></tr>
<tr id="119"><td class="linenumbers"> </td><td class="linenumbers">197</td><td class="ins"><ins>+		if ( !isset( $bits['m'] ) ) {</ins></td></tr>
<tr id="120"><td class="linenumbers"> </td><td class="linenumbers">198</td><td class="ins"><ins>+			$m = $this->makeIsoMonth( $bits['F'] );</ins></td></tr>
<tr id="121"><td class="linenumbers"> </td><td class="linenumbers">199</td><td class="ins"><ins>+			if ( !$m || $m == '00' ) {</ins></td></tr>
<tr id="122"><td class="linenumbers"> </td><td class="linenumbers">200</td><td class="ins"><ins>+				$fail = true;</ins></td></tr>
<tr id="123"><td class="linenumbers"> </td><td class="linenumbers">201</td><td class="ins"><ins>+			} else {</ins></td></tr>
<tr id="124"><td class="linenumbers"> </td><td class="linenumbers">202</td><td class="ins"><ins>+				$bits['m'] = $m;</ins></td></tr>
<tr id="125"><td class="linenumbers"> </td><td class="linenumbers">203</td><td class="ins"><ins>+			}</ins></td></tr>
<tr id="126"><td class="linenumbers"> </td><td class="linenumbers">204</td><td class="ins"><ins>+		}</ins></td></tr>
<tr id="127"><td class="linenumbers"> </td><td class="linenumbers">205</td><td class="ins"><ins>+		</ins></td></tr>
<tr id="128"><td class="linenumbers"> </td><td class="linenumbers">206</td><td class="ins"><ins>+		if ( !isset($bits['d']) ) {</ins></td></tr>
<tr id="129"><td class="linenumbers"> </td><td class="linenumbers">207</td><td class="ins"><ins>+			$bits['d'] = sprintf( '%02d', $bits['j'] );</ins></td></tr>
<tr id="130"><td class="linenumbers"> </td><td class="linenumbers">208</td><td class="ins"><ins>+		}</ins></td></tr>
<tr id="131"><td class="linenumbers">175</td><td class="linenumbers">209</td><td class="unchanged"><span> </span></td></tr>
<tr id="132"><td class="linenumbers">176</td><td class="linenumbers">210</td><td class="unchanged"><span> 		for ( $p=0; $p &lt; strlen( $format ); $p++ ) {</span></td></tr>
<tr id="133"><td class="linenumbers">177</td><td class="linenumbers">211</td><td class="unchanged"><span> 			$char = $format{$p};</span></td></tr>
<tr id="134"><td class="linenumbers">178</td><td class="linenumbers">212</td><td class="unchanged"><span> 			switch ( $char ) {</span></td></tr>
<tr id="135"><td class="linenumbers">179</td><td class="linenumbers">213</td><td class="unchanged"><span> 				case 'd': # ISO day of month</span></td></tr>
<tr id="136"><td class="linenumbers">180</td><td class="linenumbers"> </td><td class="del"><del>-					if ( !isset($bits['d']) ) {</del></td></tr>
<tr id="137"><td class="linenumbers">181</td><td class="linenumbers"> </td><td class="del"><del>-						$text .= sprintf( '%02d', $bits['j'] );</del></td></tr>
<tr id="138"><td class="linenumbers">182</td><td class="linenumbers"> </td><td class="del"><del>-					} else {</del></td></tr>
<tr id="139"><td class="linenumbers">183</td><td class="linenumbers"> </td><td class="del"><del>-						$text .= $bits['d'];</del></td></tr>
<tr id="140"><td class="linenumbers">184</td><td class="linenumbers"> </td><td class="del"><del>-					}</del></td></tr>
<tr id="141"><td class="linenumbers"> </td><td class="linenumbers">214</td><td class="ins"><ins>+					$text .= $bits['d'];</ins></td></tr>
<tr id="142"><td class="linenumbers">185</td><td class="linenumbers">215</td><td class="unchanged"><span> 					break;</span></td></tr>
<tr id="143"><td class="linenumbers">186</td><td class="linenumbers">216</td><td class="unchanged"><span> 				case 'm': # ISO month</span></td></tr>
<tr id="144"><td class="linenumbers">187</td><td class="linenumbers"> </td><td class="del"><del>-					if ( !isset($bits['m']) ) {</del></td></tr>
<tr id="145"><td class="linenumbers">188</td><td class="linenumbers"> </td><td class="del"><del>-						$m = $this->makeIsoMonth( $bits['F'] );</del></td></tr>
<tr id="146"><td class="linenumbers">189</td><td class="linenumbers"> </td><td class="del"><del>-						if ( !$m || $m == '00' ) {</del></td></tr>
<tr id="147"><td class="linenumbers">190</td><td class="linenumbers"> </td><td class="del"><del>-							$fail = true;</del></td></tr>
<tr id="148"><td class="linenumbers">191</td><td class="linenumbers"> </td><td class="del"><del>-						} else {</del></td></tr>
<tr id="149"><td class="linenumbers">192</td><td class="linenumbers"> </td><td class="del"><del>-							$text .= $m;</del></td></tr>
<tr id="150"><td class="linenumbers">193</td><td class="linenumbers"> </td><td class="del"><del>-						}</del></td></tr>
<tr id="151"><td class="linenumbers">194</td><td class="linenumbers"> </td><td class="del"><del>-					} else {</del></td></tr>
<tr id="152"><td class="linenumbers">195</td><td class="linenumbers"> </td><td class="del"><del>-						$text .= $bits['m'];</del></td></tr>
<tr id="153"><td class="linenumbers">196</td><td class="linenumbers"> </td><td class="del"><del>-					}</del></td></tr>
<tr id="154"><td class="linenumbers"> </td><td class="linenumbers">217</td><td class="ins"><ins>+					$text .= $bits['m'];</ins></td></tr>
<tr id="155"><td class="linenumbers">197</td><td class="linenumbers">218</td><td class="unchanged"><span> 					break;</span></td></tr>
<tr id="156"><td class="linenumbers">198</td><td class="linenumbers">219</td><td class="unchanged"><span> 				case 'y': # ISO year</span></td></tr>
<tr id="157"><td class="linenumbers">199</td><td class="linenumbers">220</td><td class="unchanged"><span> 					$text .= $bits['y'];</span></td></tr>
<tr id="158"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -228,7 +249,12 @@</span></td></tr>
<tr id="159"><td class="linenumbers">229</td><td class="linenumbers">250</td><td class="unchanged"><span> 			$text = $matches[0];</span></td></tr>
<tr id="160"><td class="linenumbers">230</td><td class="linenumbers">251</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="161"><td class="linenumbers">231</td><td class="linenumbers">252</td><td class="unchanged"><span> 		</span></td></tr>
<tr id="162"><td class="linenumbers">232</td><td class="linenumbers"> </td><td class="del"><del>-		$isoDate = $bits['y'].$bits['m'].$bits['d'];</del></td></tr>
<tr id="163"><td class="linenumbers"> </td><td class="linenumbers">253</td><td class="ins"><ins>+		$isoBits = array();</ins></td></tr>
<tr id="164"><td class="linenumbers"> </td><td class="linenumbers">254</td><td class="ins"><ins>+		if ( isset($bits['y']) )</ins></td></tr>
<tr id="165"><td class="linenumbers"> </td><td class="linenumbers">255</td><td class="ins"><ins>+			$isoBits[] = $bits['y'];</ins></td></tr>
<tr id="166"><td class="linenumbers"> </td><td class="linenumbers">256</td><td class="ins"><ins>+		$isoBits[] = $bits['m'];</ins></td></tr>
<tr id="167"><td class="linenumbers"> </td><td class="linenumbers">257</td><td class="ins"><ins>+		$isoBits[] = $bits['d'];</ins></td></tr>
<tr id="168"><td class="linenumbers"> </td><td class="linenumbers">258</td><td class="ins"><ins>+		$isoDate = implode( '-', $isoBits );;</ins></td></tr>
<tr id="169"><td class="linenumbers">233</td><td class="linenumbers">259</td><td class="unchanged"><span> 		</span></td></tr>
<tr id="170"><td class="linenumbers">234</td><td class="linenumbers">260</td><td class="unchanged"><span> 		// Output is not strictly HTML (it's wikitext), but &lt;span> is whitelisted.</span></td></tr>
<tr id="171"><td class="linenumbers">235</td><td class="linenumbers">261</td><td class="unchanged"><span> 		$text = Xml::tags( 'span',</span></td></tr>
<tr id="172" class="patchedfile"><td colspan="3">Index: trunk/phase3/languages/messages/MessagesEn.php</td></tr>



<tr id="176"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -338,6 +338,7 @@</span></td></tr>
<tr id="177"><td class="linenumbers">339</td><td class="linenumbers">339</td><td class="unchanged"><span> 	'numberingroup'          => array( 1,    'NUMBERINGROUP', 'NUMINGROUP' ),</span></td></tr>
<tr id="178"><td class="linenumbers">340</td><td class="linenumbers">340</td><td class="unchanged"><span> 	'staticredirect'         => array( 1,    '__STATICREDIRECT__'     ),</span></td></tr>
<tr id="179"><td class="linenumbers">341</td><td class="linenumbers">341</td><td class="unchanged"><span> 	'protectionlevel'        => array( 1,    'PROTECTIONLEVEL'        ),</span></td></tr>
<tr id="180"><td class="linenumbers"> </td><td class="linenumbers">342</td><td class="ins"><ins>+	'formatdate'			 => array( 0, 	 'formatdate', 'dateformat' ),</ins></td></tr>
<tr id="181"><td class="linenumbers">342</td><td class="linenumbers">343</td><td class="unchanged"><span> );</span></td></tr>
<tr id="182"><td class="linenumbers">343</td><td class="linenumbers">344</td><td class="unchanged"><span> </span></td></tr>
<tr id="183"><td class="linenumbers">344</td><td class="linenumbers">345</td><td class="unchanged"><span> /**</span></td></tr>
</table>
</div>
<h2 id='code-references'>Follow-up revisions</h2>
<table border='1' class='wikitable'><tr><th>Revision</th><th>Commit summary</th><th>Author</th><th>Date</th></tr><tr class='mw-codereview-status-ok'><td><a href="./48254.html" title="Special:Code/MediaWiki/48254">r48254</a></td><td>Tweak <a href="./48249.html" title="Special:Code/MediaWiki/48249">r48249</a> -- allow specification of the default format, and require the da...</td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki/author/werdna" title="Special:Code/MediaWiki/author/werdna">werdna</a></td><td>05:19, 10 March 2009</td></tr>
<tr class='mw-codereview-status-ok'><td><a href="./70651.html" title="Special:Code/MediaWiki/70651">r70651</a></td><td>Revert <a href="./70533.html" title="Special:Code/MediaWiki/70533">r70533</a> and the piece of <a href="./70501.html" title="Special:Code/MediaWiki/70501">r70501</a> that it tried to fix. Note and open bug...</td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki/author/platonides" title="Special:Code/MediaWiki/author/platonides">platonides</a></td><td>21:21, 7 August 2010</td></tr></table><h2 id='code-comments'>Comments</h2>
<div class='mw-codereview-comments'><div class="mw-codereview-comment" id="c1957" style="margin-left: 0px"><div class="mw-codereview-comment-meta"><a href="./48249.html#c1957" title="Special:Code/MediaWiki/48249">#</a>Comment by <a href="https://www.mediawiki.org/wiki/User:Anomie" class="mw-userlink" title="User:Anomie"><bdi>Anomie</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Anomie" class="mw-usertoollinks-talk" title="User talk:Anomie">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Anomie" class="mw-usertoollinks-contribs" title="Special:Contributions/Anomie">contribs</a>)</span> &#160; 03:41, 10 March 2009 </div><div class="mw-codereview-comment-text mw-content-ltr"><p>{{#formatdate:9 March 2009}} outputs the following:
</p>
<pre>9 &lt;span class="mw-formatted-date" title="<span class="mw-formatted-date" title="0009-03-20">0009-03-20</span>"&gt;<span class="mw-formatted-date" title="03-20">March 20</span>, 09&lt;/span&gt;
</pre>
<p>Also, if you could throw in a magic word (like DEFAULTSORT does for category sort keys) to make #formatdate use a particular format for users with no preference, that would make it even more useful. Otherwise enwiki people will just complain "It's still no good because IP users will see mismatched dates".
</p></div></div>
<div class="mw-codereview-comment" id="c1960" style="margin-left: 48px"><div class="mw-codereview-comment-meta"><a href="./48249.html#c1960" title="Special:Code/MediaWiki/48249">#</a>Comment by <a href="https://www.mediawiki.org/wiki/User:Werdna" class="mw-userlink" title="User:Werdna"><bdi>Werdna</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Werdna" class="mw-usertoollinks-talk" title="User talk:Werdna">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Werdna" class="mw-usertoollinks-contribs" title="Special:Contributions/Werdna">contribs</a>)</span> &#160; 05:19, 10 March 2009 </div><div class="mw-codereview-comment-text mw-content-ltr"><p>Thanks for the feedback
</p><p>Fixed in <a href="./48254.html" title="Special:Code/MediaWiki/48254">r48254</a>.
</p></div></div>
<div class="mw-codereview-comment" id="c1958" style="margin-left: 0px"><div class="mw-codereview-comment-meta"><a href="./48249.html#c1958" title="Special:Code/MediaWiki/48249">#</a>Comment by <a href="https://www.mediawiki.org/wiki/User:Tony1" class="mw-userlink" title="User:Tony1"><bdi>Tony1</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Tony1" class="mw-usertoollinks-talk" title="User talk:Tony1">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Tony1" class="mw-usertoollinks-contribs" title="Special:Contributions/Tony1">contribs</a>)</span> &#160; 04:28, 10 March 2009 </div><div class="mw-codereview-comment-text mw-content-ltr"><p>Is there a list of specs? Is there a demonstration? Has it been tested?
</p></div></div>
<div class="mw-codereview-comment" id="c1959" style="margin-left: 48px"><div class="mw-codereview-comment-meta"><a href="./48249.html#c1959" title="Special:Code/MediaWiki/48249">#</a>Comment by <a href="https://www.mediawiki.org/wiki/User:Werdna" class="mw-userlink" title="User:Werdna"><bdi>Werdna</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Werdna" class="mw-usertoollinks-talk" title="User talk:Werdna">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Werdna" class="mw-usertoollinks-contribs" title="Special:Contributions/Werdna">contribs</a>)</span> &#160; 04:34, 10 March 2009 </div><div class="mw-codereview-comment-text mw-content-ltr"><p>This is a very simple fix. Specs are "It applies the same magic applied to linked dates without linking them" (i.e. what I wrote in the commit message and release notes)
</p><p>There was no need to set up a live demonstration, although you're welcome to do it yourself.
</p><p>Like anything committed to subversion (we hope), it was tested before committing.
</p></div></div>
<div class="mw-codereview-comment" id="c1961" style="margin-left: 48px"><div class="mw-codereview-comment-meta"><a href="./48249.html#c1961" title="Special:Code/MediaWiki/48249">#</a>Comment by <a href="https://www.mediawiki.org/wiki/User:Locke_Cole" class="mw-userlink" title="User:Locke Cole"><bdi>Locke Cole</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Locke_Cole" class="mw-usertoollinks-talk" title="User talk:Locke Cole">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Locke_Cole" class="mw-usertoollinks-contribs" title="Special:Contributions/Locke Cole">contribs</a>)</span> &#160; 06:05, 10 March 2009 </div><div class="mw-codereview-comment-text mw-content-ltr"><p>Would you like fries with that?
</p></div></div>
<div class="mw-codereview-comment" id="c1967" style="margin-left: 0px"><div class="mw-codereview-comment-meta"><a href="./48249.html#c1967" title="Special:Code/MediaWiki/48249">#</a>Comment by <a href="https://www.mediawiki.org/w/index.php?title=User:UC_Bill&amp;action=edit&amp;redlink=1" class="new mw-userlink" title="User:UC Bill (page does not exist)"><bdi>UC Bill</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/w/index.php?title=User_talk:UC_Bill&amp;action=edit&amp;redlink=1" class="new mw-usertoollinks-talk" title="User talk:UC Bill (page does not exist)">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/UC_Bill" class="mw-usertoollinks-contribs" title="Special:Contributions/UC Bill">contribs</a>)</span> &#160; 15:16, 10 March 2009 </div><div class="mw-codereview-comment-text mw-content-ltr"><p>First, a nitpick:  Escaping closing braces is unnecessary unless you're within the context of an open brace, so your changes to the prx* lines don't actually do anything... however, if you just want to clean up the code to be easier to read, you should also change the prxISO1 (missed a set of closing braces there.)
</p><p>More substantially, I'm not so sure about the changes you made to the case statements, getting rid of the checks on the "ISO" bits.  Note that there's a transformation there from the 'j' or 'F' bits into their equivalent 'd' or 'm' form, which is no longer taking place in the changed version.  I'll checkout a fresh copy of the code and try to come up with some test cases, but you might want to look into it as well.
</p><p>Good work, by the way!  I think this might make a template solution feasible, or at least be a step in that direction.
</p><p><br />
</p></div></div>
<div class="mw-codereview-comment" id="c1968" style="margin-left: 48px"><div class="mw-codereview-comment-meta"><a href="./48249.html#c1968" title="Special:Code/MediaWiki/48249">#</a>Comment by <a href="https://www.mediawiki.org/w/index.php?title=User:UC_Bill&amp;action=edit&amp;redlink=1" class="new mw-userlink" title="User:UC Bill (page does not exist)"><bdi>UC Bill</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/w/index.php?title=User_talk:UC_Bill&amp;action=edit&amp;redlink=1" class="new mw-usertoollinks-talk" title="User talk:UC Bill (page does not exist)">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/UC_Bill" class="mw-usertoollinks-contribs" title="Special:Contributions/UC Bill">contribs</a>)</span> &#160; 15:20, 10 March 2009 </div><div class="mw-codereview-comment-text mw-content-ltr"><p>Gah.  I meant "brackets" not "braces" (gotta remember which are the square and which are the curly..&#160;:)
</p></div></div>
<div class="mw-codereview-comment" id="c1969" style="margin-left: 96px"><div class="mw-codereview-comment-meta"><a href="./48249.html#c1969" title="Special:Code/MediaWiki/48249">#</a>Comment by <a href="https://www.mediawiki.org/w/index.php?title=User:UC_Bill&amp;action=edit&amp;redlink=1" class="new mw-userlink" title="User:UC Bill (page does not exist)"><bdi>UC Bill</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/w/index.php?title=User_talk:UC_Bill&amp;action=edit&amp;redlink=1" class="new mw-usertoollinks-talk" title="User talk:UC Bill (page does not exist)">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/UC_Bill" class="mw-usertoollinks-contribs" title="Special:Contributions/UC Bill">contribs</a>)</span> &#160; 15:40, 10 March 2009 </div><div class="mw-codereview-comment-text mw-content-ltr"><p>Ah, thanks Werdna for the explanation on enwiki.  For the record, the 'j' and 'F' bits I was referring to are now taken care of before the case statements are even reached.  I'll still checkout a fresh copy and run some test cases, if only to shut up the critics on enwiki who are complaining about the lack of transparency in the test/commit process.  I expect the code will work fine, though.
</p></div></div>
<div class="mw-codereview-comment" id="c2037" style="margin-left: 0px"><div class="mw-codereview-comment-meta"><a href="./48249.html#c2037" title="Special:Code/MediaWiki/48249">#</a>Comment by <a href="https://www.mediawiki.org/wiki/User:Brion_VIBBER" class="mw-userlink" title="User:Brion VIBBER"><bdi>Brion VIBBER</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Brion_VIBBER" class="mw-usertoollinks-talk" title="User talk:Brion VIBBER">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Brion_VIBBER" class="mw-usertoollinks-contribs" title="Special:Contributions/Brion VIBBER">contribs</a>)</span> &#160; 23:03, 18 March 2009 </div><div class="mw-codereview-comment-text mw-content-ltr"><p>This really needs parser test cases...
</p></div></div>
<div class="mw-codereview-comment" id="c2054" style="margin-left: 0px"><div class="mw-codereview-comment-meta"><a href="./48249.html#c2054" title="Special:Code/MediaWiki/48249">#</a>Comment by <a href="https://www.mediawiki.org/wiki/User:Remember_the_dot" class="mw-userlink" title="User:Remember the dot"><bdi>Remember the dot</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Remember_the_dot" class="mw-usertoollinks-talk" title="User talk:Remember the dot">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Remember_the_dot" class="mw-usertoollinks-contribs" title="Special:Contributions/Remember the dot">contribs</a>)</span> &#160; 17:05, 20 March 2009 </div><div class="mw-codereview-comment-text mw-content-ltr"><p>How would this function be used? Please give specific examples.
</p></div></div>
<div class="mw-codereview-comment" id="c2188" style="margin-left: 0px"><div class="mw-codereview-comment-meta"><a href="./48249.html#c2188" title="Special:Code/MediaWiki/48249">#</a>Comment by <a href="https://www.mediawiki.org/wiki/User:Tony1" class="mw-userlink" title="User:Tony1"><bdi>Tony1</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Tony1" class="mw-usertoollinks-talk" title="User talk:Tony1">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Tony1" class="mw-usertoollinks-contribs" title="Special:Contributions/Tony1">contribs</a>)</span> &#160; 14:54, 11 April 2009 </div><div class="mw-codereview-comment-text mw-content-ltr"><p>Pity IP users and the vanishingly small proportion of registered users who choose a preference will see different displays: that is asking for trouble. Pity about the total failure to deal with all of the other major problems with the blue-wash autoformatting, like date ranges (getting the en dash, spaced or unspaced, right, and not requiring huge amounts of redundancy, such as "January 4 – January 6, 1980". And has it been tested, we all want to know.
</p></div></div>
<div class="mw-codereview-comment" id="c2189" style="margin-left: 48px"><div class="mw-codereview-comment-meta"><a href="./48249.html#c2189" title="Special:Code/MediaWiki/48249">#</a>Comment by <a href="https://www.mediawiki.org/wiki/User:Werdna" class="mw-userlink" title="User:Werdna"><bdi>Werdna</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Werdna" class="mw-usertoollinks-talk" title="User talk:Werdna">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Werdna" class="mw-usertoollinks-contribs" title="Special:Contributions/Werdna">contribs</a>)</span> &#160; 15:18, 11 April 2009 </div><div class="mw-codereview-comment-text mw-content-ltr"><p>With respect, what on Earth are you on about?
</p><p>If there is a specific problem with this revision, please let me know and I'll endeavour to fix it. If you have a specific question, please ask it and I'll endeavour to answer it.
</p><p>Random rants with no particular actionable statements will probably be ignored.
</p></div></div></div><h2 id='code-changes'>Status &amp; tagging log</h2>
<ul class='mw-codereview-changes'><li>01:45, 25 March 2009&#160;<a href="https://www.mediawiki.org/wiki/User:Brion_VIBBER" class="mw-userlink" title="User:Brion VIBBER"><bdi>Brion VIBBER</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Brion_VIBBER" class="mw-usertoollinks-talk" title="User talk:Brion VIBBER">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Brion_VIBBER" class="mw-usertoollinks-contribs" title="Special:Contributions/Brion VIBBER">contribs</a>)</span>&#160;changed the <b>status</b> of r48249 <i>[<b>removed:</b> fixme&#160;<b>added:</b> resolved]</i></li>
<li>23:03, 18 March 2009&#160;<a href="https://www.mediawiki.org/wiki/User:Brion_VIBBER" class="mw-userlink" title="User:Brion VIBBER"><bdi>Brion VIBBER</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Brion_VIBBER" class="mw-usertoollinks-talk" title="User talk:Brion VIBBER">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Brion_VIBBER" class="mw-usertoollinks-contribs" title="Special:Contributions/Brion VIBBER">contribs</a>)</span>&#160;changed the <b>status</b> of r48249 <i>[<b>removed:</b> new&#160;<b>added:</b> fixme]</i></li></ul></form></div>
</body>
</html>
 contentType 9 text/html url 64 https://static-codereview.wikimedia.org:443/MediaWiki/48249.html responseCode 3 200 