ioookgdkqstoaojaledqwguaigikogtohamezkxa length 5 60932 page 60932 
<html>
<head>
<title>r37928 MediaWiki - Code Review archive</title>
<meta charset="utf-8">
<link rel="stylesheet" href="../ext.codereview.styles.css"/>
</head>
<body>
<h1>r37928 MediaWiki - Code Review archive</h1>
<div id="mw-content-text" class="mw-body-content"><form action="/wiki/Special:Code/MediaWiki/37928" method="post"><table class="mw-codereview-meta"><tr><td>Repository:</td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki" title="Special:Code/MediaWiki">MediaWiki</a></td></tr>
<tr><td>Revision:</td><td>&lt;&#160;<a href="./37927.html" title="Special:Code/MediaWiki/37927">r37927</a>‎ | <b>r37928</b> | <a href="./37929.html" title="Special:Code/MediaWiki/37929">r37929</a>&#160;&gt;</td></tr>
<tr><td>Date:</td><td>22:44, 22 July 2008</td></tr>
<tr><td>Author:</td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki/author/tstarling" title="Special:Code/MediaWiki/author/tstarling">tstarling</a></td></tr>
<tr><td>Status:</td><td>old</td></tr>
<tr><td>Tags:</td><td></td></tr>
<tr><td>Comment:</td><td><div class="mw-codereview-message">* (<a class="external" href="https://bugzilla.wikimedia.org/show_bug.cgi?id=4578">bug 4578</a>) Automatically fix redirects broken by a page move. Works via the job queue, controllable by a checkbox on Special:Movepage.<br />
* Renamed some excessively short variables in SpecialMovepage.php<br />
* Allow $wgReservedUsernames to be localised using &quot;msg:...&quot; syntax</div></td></tr>
<tr><td>Modified paths:</td><td><div class='mw-codereview-paths mw-content-ltr'><ul>
<li><b>/trunk/phase3/RELEASE-NOTES</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2FRELEASE-NOTES" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/includes/AutoLoader.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2FAutoLoader.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/includes/DefaultSettings.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2FDefaultSettings.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/includes/JobQueue.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2FJobQueue.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/includes/User.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2FUser.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/includes/specials/SpecialMovepage.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2Fspecials%2FSpecialMovepage.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/languages/messages/MessagesEn.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Flanguages%2Fmessages%2FMessagesEn.php" title="Special:Code/MediaWiki">history</a>)</li>
</ul></div>
</td></tr>
</table>
<h2>Diff <small>[<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki/37928&amp;action=purge" title="Special:Code/MediaWiki/37928">purge</a>]</small></h2><div class='mw-codereview-diff' id='mw-codereview-diff'><table class="mw-codereview-diff"><tr id="1" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/User.php</td></tr>



<tr id="5"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -497,12 +497,21 @@</span></td></tr>
<tr id="6"><td class="linenumbers">498</td><td class="linenumbers">498</td><td class="unchanged"><span> 	 */</span></td></tr>
<tr id="7"><td class="linenumbers">499</td><td class="linenumbers">499</td><td class="unchanged"><span> 	static function isUsableName( $name ) {</span></td></tr>
<tr id="8"><td class="linenumbers">500</td><td class="linenumbers">500</td><td class="unchanged"><span> 		global $wgReservedUsernames;</span></td></tr>
<tr id="9"><td class="linenumbers">501</td><td class="linenumbers"> </td><td class="del"><del>-		return</del></td></tr>
<tr id="10"><td class="linenumbers">502</td><td class="linenumbers"> </td><td class="del"><del>-			// Must be a valid username, obviously ;)</del></td></tr>
<tr id="11"><td class="linenumbers">503</td><td class="linenumbers"> </td><td class="del"><del>-			self::isValidUserName( $name ) &amp;&amp;</del></td></tr>
<tr id="12"><td class="linenumbers"> </td><td class="linenumbers">501</td><td class="ins"><ins>+		// Must be a valid username, obviously ;)</ins></td></tr>
<tr id="13"><td class="linenumbers"> </td><td class="linenumbers">502</td><td class="ins"><ins>+		if ( !self::isValidUserName( $name ) ) {</ins></td></tr>
<tr id="14"><td class="linenumbers"> </td><td class="linenumbers">503</td><td class="ins"><ins>+			return false;</ins></td></tr>
<tr id="15"><td class="linenumbers"> </td><td class="linenumbers">504</td><td class="ins"><ins>+		}</ins></td></tr>
<tr id="16"><td class="linenumbers">504</td><td class="linenumbers">505</td><td class="unchanged"><span> </span></td></tr>
<tr id="17"><td class="linenumbers">505</td><td class="linenumbers"> </td><td class="del"><del>-			// Certain names may be reserved for batch processes.</del></td></tr>
<tr id="18"><td class="linenumbers">506</td><td class="linenumbers"> </td><td class="del"><del>-			!in_array( $name, $wgReservedUsernames );</del></td></tr>
<tr id="19"><td class="linenumbers"> </td><td class="linenumbers">506</td><td class="ins"><ins>+		// Certain names may be reserved for batch processes.</ins></td></tr>
<tr id="20"><td class="linenumbers"> </td><td class="linenumbers">507</td><td class="ins"><ins>+		foreach ( $wgReservedUsernames as $reserved ) {</ins></td></tr>
<tr id="21"><td class="linenumbers"> </td><td class="linenumbers">508</td><td class="ins"><ins>+			if ( substr( $reserved, 0, 4 ) == 'msg:' ) {</ins></td></tr>
<tr id="22"><td class="linenumbers"> </td><td class="linenumbers">509</td><td class="ins"><ins>+				$reserved = wfMsgForContent( substr( $reserved, 4 ) );</ins></td></tr>
<tr id="23"><td class="linenumbers"> </td><td class="linenumbers">510</td><td class="ins"><ins>+			}</ins></td></tr>
<tr id="24"><td class="linenumbers"> </td><td class="linenumbers">511</td><td class="ins"><ins>+			if ( $reserved == $name ) {</ins></td></tr>
<tr id="25"><td class="linenumbers"> </td><td class="linenumbers">512</td><td class="ins"><ins>+				return false;</ins></td></tr>
<tr id="26"><td class="linenumbers"> </td><td class="linenumbers">513</td><td class="ins"><ins>+			}</ins></td></tr>
<tr id="27"><td class="linenumbers"> </td><td class="linenumbers">514</td><td class="ins"><ins>+		}</ins></td></tr>
<tr id="28"><td class="linenumbers"> </td><td class="linenumbers">515</td><td class="ins"><ins>+		return true;</ins></td></tr>
<tr id="29"><td class="linenumbers">507</td><td class="linenumbers">516</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="30"><td class="linenumbers">508</td><td class="linenumbers">517</td><td class="unchanged"><span> </span></td></tr>
<tr id="31"><td class="linenumbers">509</td><td class="linenumbers">518</td><td class="unchanged"><span> 	/**</span></td></tr>
<tr id="32" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/DefaultSettings.php</td></tr>



<tr id="36"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -1595,6 +1595,7 @@</span></td></tr>
<tr id="37"><td class="linenumbers">1596</td><td class="linenumbers">1596</td><td class="unchanged"><span> 	'html_cache_update' => 'HTMLCacheUpdateJob', // backwards-compatible</span></td></tr>
<tr id="38"><td class="linenumbers">1597</td><td class="linenumbers">1597</td><td class="unchanged"><span> 	'sendMail' => 'EmaillingJob',</span></td></tr>
<tr id="39"><td class="linenumbers">1598</td><td class="linenumbers">1598</td><td class="unchanged"><span> 	'enotifNotify' => 'EnotifNotifyJob',</span></td></tr>
<tr id="40"><td class="linenumbers"> </td><td class="linenumbers">1599</td><td class="ins"><ins>+	'fixDoubleRedirect' => 'DoubleRedirectJob',</ins></td></tr>
<tr id="41"><td class="linenumbers">1599</td><td class="linenumbers">1600</td><td class="unchanged"><span> );</span></td></tr>
<tr id="42"><td class="linenumbers">1600</td><td class="linenumbers">1601</td><td class="unchanged"><span> </span></td></tr>
<tr id="43"><td class="linenumbers">1601</td><td class="linenumbers">1602</td><td class="unchanged"><span> /**</span></td></tr>
<tr id="44"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -3078,6 +3079,7 @@</span></td></tr>
<tr id="45"><td class="linenumbers">3079</td><td class="linenumbers">3080</td><td class="unchanged"><span> 	'Conversion script', // Used for the old Wikipedia software upgrade</span></td></tr>
<tr id="46"><td class="linenumbers">3080</td><td class="linenumbers">3081</td><td class="unchanged"><span> 	'Maintenance script', // Maintenance scripts which perform editing, image import script</span></td></tr>
<tr id="47"><td class="linenumbers">3081</td><td class="linenumbers">3082</td><td class="unchanged"><span> 	'Template namespace initialisation script', // Used in 1.2->1.3 upgrade</span></td></tr>
<tr id="48"><td class="linenumbers"> </td><td class="linenumbers">3083</td><td class="ins"><ins>+	'msg:double-redirect-fixer', // Automatic double redirect fix</ins></td></tr>
<tr id="49"><td class="linenumbers">3082</td><td class="linenumbers">3084</td><td class="unchanged"><span> );</span></td></tr>
<tr id="50"><td class="linenumbers">3083</td><td class="linenumbers">3085</td><td class="unchanged"><span> </span></td></tr>
<tr id="51"><td class="linenumbers">3084</td><td class="linenumbers">3086</td><td class="unchanged"><span> /**</span></td></tr>
<tr id="52" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/JobQueue.php</td></tr>



<tr id="56"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -163,7 +163,10 @@</span></td></tr>
<tr id="57"><td class="linenumbers">164</td><td class="linenumbers">164</td><td class="unchanged"><span> 		$job = Job::factory( $row->job_cmd, $title, Job::extractBlob( $row->job_params ), $row->job_id );</span></td></tr>
<tr id="58"><td class="linenumbers">165</td><td class="linenumbers">165</td><td class="unchanged"><span> </span></td></tr>
<tr id="59"><td class="linenumbers">166</td><td class="linenumbers">166</td><td class="unchanged"><span> 		// Remove any duplicates it may have later in the queue</span></td></tr>
<tr id="60"><td class="linenumbers"> </td><td class="linenumbers">167</td><td class="ins"><ins>+		// Deadlock prone section</ins></td></tr>
<tr id="61"><td class="linenumbers"> </td><td class="linenumbers">168</td><td class="ins"><ins>+		$dbw->begin();</ins></td></tr>
<tr id="62"><td class="linenumbers">167</td><td class="linenumbers">169</td><td class="unchanged"><span> 		$dbw->delete( 'job', $job->insertFields(), __METHOD__ );</span></td></tr>
<tr id="63"><td class="linenumbers"> </td><td class="linenumbers">170</td><td class="ins"><ins>+		$dbw->commit();</ins></td></tr>
<tr id="64"><td class="linenumbers">168</td><td class="linenumbers">171</td><td class="unchanged"><span> </span></td></tr>
<tr id="65"><td class="linenumbers">169</td><td class="linenumbers">172</td><td class="unchanged"><span> 		wfProfileOut( __METHOD__ );</span></td></tr>
<tr id="66"><td class="linenumbers">170</td><td class="linenumbers">173</td><td class="unchanged"><span> 		return $job;</span></td></tr>
<tr id="67"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -213,12 +216,23 @@</span></td></tr>
<tr id="68"><td class="linenumbers">214</td><td class="linenumbers">217</td><td class="unchanged"><span> 	 * @param $jobs array of Job objects</span></td></tr>
<tr id="69"><td class="linenumbers">215</td><td class="linenumbers">218</td><td class="unchanged"><span> 	 */</span></td></tr>
<tr id="70"><td class="linenumbers">216</td><td class="linenumbers">219</td><td class="unchanged"><span> 	static function batchInsert( $jobs ) {</span></td></tr>
<tr id="71"><td class="linenumbers">217</td><td class="linenumbers"> </td><td class="del"><del>-		if( count( $jobs ) ) {</del></td></tr>
<tr id="72"><td class="linenumbers">218</td><td class="linenumbers"> </td><td class="del"><del>-			$dbw = wfGetDB( DB_MASTER );</del></td></tr>
<tr id="73"><td class="linenumbers"> </td><td class="linenumbers">220</td><td class="ins"><ins>+		if( !count( $jobs ) ) {</ins></td></tr>
<tr id="74"><td class="linenumbers"> </td><td class="linenumbers">221</td><td class="ins"><ins>+			return;</ins></td></tr>
<tr id="75"><td class="linenumbers"> </td><td class="linenumbers">222</td><td class="ins"><ins>+		}</ins></td></tr>
<tr id="76"><td class="linenumbers"> </td><td class="linenumbers">223</td><td class="ins"><ins>+		$dbw = wfGetDB( DB_MASTER );</ins></td></tr>
<tr id="77"><td class="linenumbers"> </td><td class="linenumbers">224</td><td class="ins"><ins>+		$rows = array();</ins></td></tr>
<tr id="78"><td class="linenumbers"> </td><td class="linenumbers">225</td><td class="ins"><ins>+		foreach( $jobs as $job ) {</ins></td></tr>
<tr id="79"><td class="linenumbers"> </td><td class="linenumbers">226</td><td class="ins"><ins>+			$rows[] = $job->insertFields();</ins></td></tr>
<tr id="80"><td class="linenumbers"> </td><td class="linenumbers">227</td><td class="ins"><ins>+			if ( count( $rows ) >= 50 ) {</ins></td></tr>
<tr id="81"><td class="linenumbers"> </td><td class="linenumbers">228</td><td class="ins"><ins>+				# Do a small transaction to avoid slave lag</ins></td></tr>
<tr id="82"><td class="linenumbers"> </td><td class="linenumbers">229</td><td class="ins"><ins>+				$dbw->begin();</ins></td></tr>
<tr id="83"><td class="linenumbers"> </td><td class="linenumbers">230</td><td class="ins"><ins>+				$dbw->insert( 'job', $rows, __METHOD__, 'IGNORE' );</ins></td></tr>
<tr id="84"><td class="linenumbers"> </td><td class="linenumbers">231</td><td class="ins"><ins>+				$dbw->commit();</ins></td></tr>
<tr id="85"><td class="linenumbers"> </td><td class="linenumbers">232</td><td class="ins"><ins>+				$rows = array();</ins></td></tr>
<tr id="86"><td class="linenumbers"> </td><td class="linenumbers">233</td><td class="ins"><ins>+			}</ins></td></tr>
<tr id="87"><td class="linenumbers"> </td><td class="linenumbers">234</td><td class="ins"><ins>+		}</ins></td></tr>
<tr id="88"><td class="linenumbers"> </td><td class="linenumbers">235</td><td class="ins"><ins>+		if ( $rows ) {</ins></td></tr>
<tr id="89"><td class="linenumbers">219</td><td class="linenumbers">236</td><td class="unchanged"><span> 			$dbw->begin();</span></td></tr>
<tr id="90"><td class="linenumbers">220</td><td class="linenumbers"> </td><td class="del"><del>-			foreach( $jobs as $job ) {</del></td></tr>
<tr id="91"><td class="linenumbers">221</td><td class="linenumbers"> </td><td class="del"><del>-				$rows[] = $job->insertFields();</del></td></tr>
<tr id="92"><td class="linenumbers">222</td><td class="linenumbers"> </td><td class="del"><del>-			}</del></td></tr>
<tr id="93"><td class="linenumbers">223</td><td class="linenumbers">237</td><td class="unchanged"><span> 			$dbw->insert( 'job', $rows, __METHOD__, 'IGNORE' );</span></td></tr>
<tr id="94"><td class="linenumbers">224</td><td class="linenumbers">238</td><td class="unchanged"><span> 			$dbw->commit();</span></td></tr>
<tr id="95"><td class="linenumbers">225</td><td class="linenumbers">239</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="96"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -288,6 +302,10 @@</span></td></tr>
<tr id="97"><td class="linenumbers">289</td><td class="linenumbers">303</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="98"><td class="linenumbers">290</td><td class="linenumbers">304</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="99"><td class="linenumbers">291</td><td class="linenumbers">305</td><td class="unchanged"><span> </span></td></tr>
<tr id="100"><td class="linenumbers"> </td><td class="linenumbers">306</td><td class="ins"><ins>+	protected function setLastError( $error ) {</ins></td></tr>
<tr id="101"><td class="linenumbers"> </td><td class="linenumbers">307</td><td class="ins"><ins>+		$this->error = $error;</ins></td></tr>
<tr id="102"><td class="linenumbers"> </td><td class="linenumbers">308</td><td class="ins"><ins>+	}</ins></td></tr>
<tr id="103"><td class="linenumbers"> </td><td class="linenumbers">309</td><td class="ins"><ins>+</ins></td></tr>
<tr id="104"><td class="linenumbers">292</td><td class="linenumbers">310</td><td class="unchanged"><span> 	function getLastError() {</span></td></tr>
<tr id="105"><td class="linenumbers">293</td><td class="linenumbers">311</td><td class="unchanged"><span> 		return $this->error;</span></td></tr>
<tr id="106"><td class="linenumbers">294</td><td class="linenumbers">312</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="107" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/AutoLoader.php</td></tr>



<tr id="111"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -43,6 +43,7 @@</span></td></tr>
<tr id="112"><td class="linenumbers">44</td><td class="linenumbers">44</td><td class="unchanged"><span> 		'_DiffOp' => 'includes/DifferenceEngine.php',</span></td></tr>
<tr id="113"><td class="linenumbers">45</td><td class="linenumbers">45</td><td class="unchanged"><span> 		'DjVuImage' => 'includes/DjVuImage.php',</span></td></tr>
<tr id="114"><td class="linenumbers">46</td><td class="linenumbers">46</td><td class="unchanged"><span> 		'DoubleReplacer' => 'includes/StringUtils.php',</span></td></tr>
<tr id="115"><td class="linenumbers"> </td><td class="linenumbers">47</td><td class="ins"><ins>+		'DoubleRedirectJob' => 'includes/DoubleRedirectJob.php',</ins></td></tr>
<tr id="116"><td class="linenumbers">47</td><td class="linenumbers">48</td><td class="unchanged"><span> 		'Dump7ZipOutput' => 'includes/Export.php',</span></td></tr>
<tr id="117"><td class="linenumbers">48</td><td class="linenumbers">49</td><td class="unchanged"><span> 		'DumpBZip2Output' => 'includes/Export.php',</span></td></tr>
<tr id="118"><td class="linenumbers">49</td><td class="linenumbers">50</td><td class="unchanged"><span> 		'DumpFileOutput' => 'includes/Export.php',</span></td></tr>
<tr id="119" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/specials/SpecialMovepage.php</td></tr>



<tr id="123"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -17,36 +17,35 @@</span></td></tr>
<tr id="124"><td class="linenumbers">18</td><td class="linenumbers">18</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="125"><td class="linenumbers">19</td><td class="linenumbers">19</td><td class="unchanged"><span> </span></td></tr>
<tr id="126"><td class="linenumbers">20</td><td class="linenumbers">20</td><td class="unchanged"><span> 	$target = isset( $par ) ? $par : $wgRequest->getVal( 'target' );</span></td></tr>
<tr id="127"><td class="linenumbers">21</td><td class="linenumbers"> </td><td class="del"><del>-	$oldTitle = $wgRequest->getText( 'wpOldTitle', $target );</del></td></tr>
<tr id="128"><td class="linenumbers">22</td><td class="linenumbers"> </td><td class="del"><del>-	$newTitle = $wgRequest->getText( 'wpNewTitle' );</del></td></tr>
<tr id="129"><td class="linenumbers"> </td><td class="linenumbers">21</td><td class="ins"><ins>+	$oldTitleText = $wgRequest->getText( 'wpOldTitle', $target );</ins></td></tr>
<tr id="130"><td class="linenumbers"> </td><td class="linenumbers">22</td><td class="ins"><ins>+	$newTitleText = $wgRequest->getText( 'wpNewTitle' );</ins></td></tr>
<tr id="131"><td class="linenumbers">23</td><td class="linenumbers">23</td><td class="unchanged"><span> </span></td></tr>
<tr id="132"><td class="linenumbers">24</td><td class="linenumbers"> </td><td class="del"><del>-	# Variables beginning with 'o' for old article 'n' for new article</del></td></tr>
<tr id="133"><td class="linenumbers">25</td><td class="linenumbers"> </td><td class="del"><del>-	$ot = Title::newFromText( $oldTitle );</del></td></tr>
<tr id="134"><td class="linenumbers">26</td><td class="linenumbers"> </td><td class="del"><del>-	$nt = Title::newFromText( $newTitle );</del></td></tr>
<tr id="135"><td class="linenumbers"> </td><td class="linenumbers">24</td><td class="ins"><ins>+	$oldTitle = Title::newFromText( $oldTitleText );</ins></td></tr>
<tr id="136"><td class="linenumbers"> </td><td class="linenumbers">25</td><td class="ins"><ins>+	$newTitle = Title::newFromText( $newTitleText );</ins></td></tr>
<tr id="137"><td class="linenumbers">27</td><td class="linenumbers">26</td><td class="unchanged"><span> </span></td></tr>
<tr id="138"><td class="linenumbers">28</td><td class="linenumbers"> </td><td class="del"><del>-	if( is_null( $ot ) ) {</del></td></tr>
<tr id="139"><td class="linenumbers"> </td><td class="linenumbers">27</td><td class="ins"><ins>+	if( is_null( $oldTitle ) ) {</ins></td></tr>
<tr id="140"><td class="linenumbers">29</td><td class="linenumbers">28</td><td class="unchanged"><span> 		$wgOut->showErrorPage( 'notargettitle', 'notargettext' );</span></td></tr>
<tr id="141"><td class="linenumbers">30</td><td class="linenumbers">29</td><td class="unchanged"><span> 		return;</span></td></tr>
<tr id="142"><td class="linenumbers">31</td><td class="linenumbers">30</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="143"><td class="linenumbers">32</td><td class="linenumbers"> </td><td class="del"><del>-	if( !$ot->exists() ) {</del></td></tr>
<tr id="144"><td class="linenumbers"> </td><td class="linenumbers">31</td><td class="ins"><ins>+	if( !$oldTitle->exists() ) {</ins></td></tr>
<tr id="145"><td class="linenumbers">33</td><td class="linenumbers">32</td><td class="unchanged"><span> 		$wgOut->showErrorPage( 'nopagetitle', 'nopagetext' );</span></td></tr>
<tr id="146"><td class="linenumbers">34</td><td class="linenumbers">33</td><td class="unchanged"><span> 		return;</span></td></tr>
<tr id="147"><td class="linenumbers">35</td><td class="linenumbers">34</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="148"><td class="linenumbers">36</td><td class="linenumbers">35</td><td class="unchanged"><span> </span></td></tr>
<tr id="149"><td class="linenumbers">37</td><td class="linenumbers">36</td><td class="unchanged"><span> 	# Check rights</span></td></tr>
<tr id="150"><td class="linenumbers">38</td><td class="linenumbers"> </td><td class="del"><del>-	$permErrors = $ot->getUserPermissionsErrors( 'move', $wgUser );</del></td></tr>
<tr id="151"><td class="linenumbers"> </td><td class="linenumbers">37</td><td class="ins"><ins>+	$permErrors = $oldTitle->getUserPermissionsErrors( 'move', $wgUser );</ins></td></tr>
<tr id="152"><td class="linenumbers">39</td><td class="linenumbers">38</td><td class="unchanged"><span> 	if( !empty( $permErrors ) ) {</span></td></tr>
<tr id="153"><td class="linenumbers">40</td><td class="linenumbers">39</td><td class="unchanged"><span> 		$wgOut->showPermissionsErrorPage( $permErrors );</span></td></tr>
<tr id="154"><td class="linenumbers">41</td><td class="linenumbers">40</td><td class="unchanged"><span> 		return;</span></td></tr>
<tr id="155"><td class="linenumbers">42</td><td class="linenumbers">41</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="156"><td class="linenumbers">43</td><td class="linenumbers">42</td><td class="unchanged"><span> </span></td></tr>
<tr id="157"><td class="linenumbers">44</td><td class="linenumbers"> </td><td class="del"><del>-	$f = new MovePageForm( $ot, $nt );</del></td></tr>
<tr id="158"><td class="linenumbers"> </td><td class="linenumbers">43</td><td class="ins"><ins>+	$form = new MovePageForm( $oldTitle, $newTitle );</ins></td></tr>
<tr id="159"><td class="linenumbers">45</td><td class="linenumbers">44</td><td class="unchanged"><span> </span></td></tr>
<tr id="160"><td class="linenumbers">46</td><td class="linenumbers">45</td><td class="unchanged"><span> 	if ( 'submit' == $action &amp;&amp; $wgRequest->wasPosted()</span></td></tr>
<tr id="161"><td class="linenumbers">47</td><td class="linenumbers">46</td><td class="unchanged"><span> 		&amp;&amp; $wgUser->matchEditToken( $wgRequest->getVal( 'wpEditToken' ) ) ) {</span></td></tr>
<tr id="162"><td class="linenumbers">48</td><td class="linenumbers"> </td><td class="del"><del>-		$f->doSubmit();</del></td></tr>
<tr id="163"><td class="linenumbers"> </td><td class="linenumbers">47</td><td class="ins"><ins>+		$form->doSubmit();</ins></td></tr>
<tr id="164"><td class="linenumbers">49</td><td class="linenumbers">48</td><td class="unchanged"><span> 	} else {</span></td></tr>
<tr id="165"><td class="linenumbers">50</td><td class="linenumbers"> </td><td class="del"><del>-		$f->showForm( '' );</del></td></tr>
<tr id="166"><td class="linenumbers"> </td><td class="linenumbers">49</td><td class="ins"><ins>+		$form->showForm( '' );</ins></td></tr>
<tr id="167"><td class="linenumbers">51</td><td class="linenumbers">50</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="168"><td class="linenumbers">52</td><td class="linenumbers">51</td><td class="unchanged"><span> }</span></td></tr>
<tr id="169"><td class="linenumbers">53</td><td class="linenumbers">52</td><td class="unchanged"><span> </span></td></tr>
<tr id="170"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -56,7 +55,7 @@</span></td></tr>
<tr id="171"><td class="linenumbers">57</td><td class="linenumbers">56</td><td class="unchanged"><span>  */</span></td></tr>
<tr id="172"><td class="linenumbers">58</td><td class="linenumbers">57</td><td class="unchanged"><span> class MovePageForm {</span></td></tr>
<tr id="173"><td class="linenumbers">59</td><td class="linenumbers">58</td><td class="unchanged"><span> 	var $oldTitle, $newTitle, $reason; # Text input</span></td></tr>
<tr id="174"><td class="linenumbers">60</td><td class="linenumbers"> </td><td class="del"><del>-	var $moveTalk, $deleteAndMove, $moveSubpages;</del></td></tr>
<tr id="175"><td class="linenumbers"> </td><td class="linenumbers">59</td><td class="ins"><ins>+	var $moveTalk, $deleteAndMove, $moveSubpages, $fixRedirects;</ins></td></tr>
<tr id="176"><td class="linenumbers">61</td><td class="linenumbers">60</td><td class="unchanged"><span> </span></td></tr>
<tr id="177"><td class="linenumbers">62</td><td class="linenumbers">61</td><td class="unchanged"><span> 	private $watch = false;</span></td></tr>
<tr id="178"><td class="linenumbers">63</td><td class="linenumbers">62</td><td class="unchanged"><span> </span></td></tr>
<tr id="179"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -73,17 +72,17 @@</span></td></tr>
<tr id="180"><td class="linenumbers">74</td><td class="linenumbers">73</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="181"><td class="linenumbers">75</td><td class="linenumbers">74</td><td class="unchanged"><span> 		$this->moveSubpages = $wgRequest->getBool( 'wpMovesubpages', false );</span></td></tr>
<tr id="182"><td class="linenumbers">76</td><td class="linenumbers">75</td><td class="unchanged"><span> 		$this->deleteAndMove = $wgRequest->getBool( 'wpDeleteAndMove' ) &amp;&amp; $wgRequest->getBool( 'wpConfirm' );</span></td></tr>
<tr id="183"><td class="linenumbers"> </td><td class="linenumbers">76</td><td class="ins"><ins>+		$this->fixRedirects = $wgRequest->getBool( 'wpFixRedirects', true );</ins></td></tr>
<tr id="184"><td class="linenumbers">77</td><td class="linenumbers">77</td><td class="unchanged"><span> 		$this->watch = $wgRequest->getCheck( 'wpWatch' );</span></td></tr>
<tr id="185"><td class="linenumbers">78</td><td class="linenumbers">78</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="186"><td class="linenumbers">79</td><td class="linenumbers">79</td><td class="unchanged"><span> </span></td></tr>
<tr id="187"><td class="linenumbers">80</td><td class="linenumbers">80</td><td class="unchanged"><span> 	function showForm( $err, $hookErr = '' ) {</span></td></tr>
<tr id="188"><td class="linenumbers">81</td><td class="linenumbers">81</td><td class="unchanged"><span> 		global $wgOut, $wgUser;</span></td></tr>
<tr id="189"><td class="linenumbers">82</td><td class="linenumbers">82</td><td class="unchanged"><span> </span></td></tr>
<tr id="190"><td class="linenumbers">83</td><td class="linenumbers"> </td><td class="del"><del>-		$ot = $this->oldTitle;</del></td></tr>
<tr id="191"><td class="linenumbers">84</td><td class="linenumbers"> </td><td class="del"><del>-		$sk = $wgUser->getSkin();</del></td></tr>
<tr id="192"><td class="linenumbers"> </td><td class="linenumbers">83</td><td class="ins"><ins>+		$skin = $wgUser->getSkin();</ins></td></tr>
<tr id="193"><td class="linenumbers">85</td><td class="linenumbers">84</td><td class="unchanged"><span> </span></td></tr>
<tr id="194"><td class="linenumbers">86</td><td class="linenumbers"> </td><td class="del"><del>-		$oldTitleLink = $sk->makeLinkObj( $ot );</del></td></tr>
<tr id="195"><td class="linenumbers">87</td><td class="linenumbers"> </td><td class="del"><del>-		$oldTitle = $ot->getPrefixedText();</del></td></tr>
<tr id="196"><td class="linenumbers"> </td><td class="linenumbers">85</td><td class="ins"><ins>+		$oldTitleLink = $skin->makeLinkObj( $this->oldTitle );</ins></td></tr>
<tr id="197"><td class="linenumbers"> </td><td class="linenumbers">86</td><td class="ins"><ins>+		$oldTitle = $this->oldTitle->getPrefixedText();</ins></td></tr>
<tr id="198"><td class="linenumbers">88</td><td class="linenumbers">87</td><td class="unchanged"><span> </span></td></tr>
<tr id="199"><td class="linenumbers">89</td><td class="linenumbers">88</td><td class="unchanged"><span> 		$wgOut->setPagetitle( wfMsg( 'move-page', $oldTitle ) );</span></td></tr>
<tr id="200"><td class="linenumbers">90</td><td class="linenumbers">89</td><td class="unchanged"><span> 		$wgOut->setSubtitle( wfMsg( 'move-page-backlink', $oldTitleLink ) );</span></td></tr>
<tr id="201"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -99,7 +98,7 @@</span></td></tr>
<tr id="202"><td class="linenumbers">100</td><td class="linenumbers">99</td><td class="unchanged"><span> 					# If a title was supplied, probably from the move log revert</span></td></tr>
<tr id="203"><td class="linenumbers">101</td><td class="linenumbers">100</td><td class="unchanged"><span> 					# link, check for validity. We can then show some diagnostic</span></td></tr>
<tr id="204"><td class="linenumbers">102</td><td class="linenumbers">101</td><td class="unchanged"><span> 					# information and save a click.</span></td></tr>
<tr id="205"><td class="linenumbers">103</td><td class="linenumbers"> </td><td class="del"><del>-					$newerr = $ot->isValidMoveOperation( $nt );</del></td></tr>
<tr id="206"><td class="linenumbers"> </td><td class="linenumbers">102</td><td class="ins"><ins>+					$newerr = $this->oldTitle->isValidMoveOperation( $nt );</ins></td></tr>
<tr id="207"><td class="linenumbers">104</td><td class="linenumbers">103</td><td class="unchanged"><span> 					if( is_string( $newerr ) ) {</span></td></tr>
<tr id="208"><td class="linenumbers">105</td><td class="linenumbers">104</td><td class="unchanged"><span> 						$err = $newerr;</span></td></tr>
<tr id="209"><td class="linenumbers">106</td><td class="linenumbers">105</td><td class="unchanged"><span> 					}</span></td></tr>
<tr id="210"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -127,9 +126,16 @@</span></td></tr>
<tr id="211"><td class="linenumbers">128</td><td class="linenumbers">127</td><td class="unchanged"><span> 			$confirm = false;</span></td></tr>
<tr id="212"><td class="linenumbers">129</td><td class="linenumbers">128</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="213"><td class="linenumbers">130</td><td class="linenumbers">129</td><td class="unchanged"><span> </span></td></tr>
<tr id="214"><td class="linenumbers">131</td><td class="linenumbers"> </td><td class="del"><del>-		$oldTalk = $ot->getTalkPage();</del></td></tr>
<tr id="215"><td class="linenumbers">132</td><td class="linenumbers"> </td><td class="del"><del>-		$considerTalk = ( !$ot->isTalkPage() &amp;&amp; $oldTalk->exists() );</del></td></tr>
<tr id="216"><td class="linenumbers"> </td><td class="linenumbers">130</td><td class="ins"><ins>+		$oldTalk = $this->oldTitle->getTalkPage();</ins></td></tr>
<tr id="217"><td class="linenumbers"> </td><td class="linenumbers">131</td><td class="ins"><ins>+		$considerTalk = ( !$this->oldTitle->isTalkPage() &amp;&amp; $oldTalk->exists() );</ins></td></tr>
<tr id="218"><td class="linenumbers">133</td><td class="linenumbers">132</td><td class="unchanged"><span> </span></td></tr>
<tr id="219"><td class="linenumbers"> </td><td class="linenumbers">133</td><td class="ins"><ins>+		$dbr = wfGetDB( DB_SLAVE );</ins></td></tr>
<tr id="220"><td class="linenumbers"> </td><td class="linenumbers">134</td><td class="ins"><ins>+		$hasRedirects = $dbr->selectField( 'redirect', '1', </ins></td></tr>
<tr id="221"><td class="linenumbers"> </td><td class="linenumbers">135</td><td class="ins"><ins>+			array( </ins></td></tr>
<tr id="222"><td class="linenumbers"> </td><td class="linenumbers">136</td><td class="ins"><ins>+				'rd_namespace' => $this->oldTitle->getNamespace(),</ins></td></tr>
<tr id="223"><td class="linenumbers"> </td><td class="linenumbers">137</td><td class="ins"><ins>+				'rd_title' => $this->oldTitle->getDBkey(),</ins></td></tr>
<tr id="224"><td class="linenumbers"> </td><td class="linenumbers">138</td><td class="ins"><ins>+			) , __METHOD__ );</ins></td></tr>
<tr id="225"><td class="linenumbers"> </td><td class="linenumbers">139</td><td class="ins"><ins>+		</ins></td></tr>
<tr id="226"><td class="linenumbers">134</td><td class="linenumbers">140</td><td class="unchanged"><span> 		if ( $considerTalk ) {</span></td></tr>
<tr id="227"><td class="linenumbers">135</td><td class="linenumbers">141</td><td class="unchanged"><span> 			$wgOut->addWikiMsg( 'movepagetalktext' );</span></td></tr>
<tr id="228"><td class="linenumbers">136</td><td class="linenumbers">142</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="229"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -190,28 +196,41 @@</span></td></tr>
<tr id="230"><td class="linenumbers">191</td><td class="linenumbers">197</td><td class="unchanged"><span> 			);</span></td></tr>
<tr id="231"><td class="linenumbers">192</td><td class="linenumbers">198</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="232"><td class="linenumbers">193</td><td class="linenumbers">199</td><td class="unchanged"><span> </span></td></tr>
<tr id="233"><td class="linenumbers">194</td><td class="linenumbers"> </td><td class="del"><del>-		if( ($ot->hasSubpages() || $ot->getTalkPage()->hasSubpages())</del></td></tr>
<tr id="234"><td class="linenumbers">195</td><td class="linenumbers"> </td><td class="del"><del>-		&amp;&amp; $ot->userCan( 'move-subpages' ) ) {</del></td></tr>
<tr id="235"><td class="linenumbers"> </td><td class="linenumbers">200</td><td class="ins"><ins>+		if ( $hasRedirects ) {</ins></td></tr>
<tr id="236"><td class="linenumbers">196</td><td class="linenumbers">201</td><td class="unchanged"><span> 			$wgOut->addHTML( "</span></td></tr>
<tr id="237"><td class="linenumbers">197</td><td class="linenumbers">202</td><td class="unchanged"><span> 				&lt;tr></span></td></tr>
<tr id="238"><td class="linenumbers">198</td><td class="linenumbers">203</td><td class="unchanged"><span> 					&lt;td>&lt;/td></span></td></tr>
<tr id="239"><td class="linenumbers"> </td><td class="linenumbers">204</td><td class="ins"><ins>+					&lt;td class='mw-input' >" .</ins></td></tr>
<tr id="240"><td class="linenumbers"> </td><td class="linenumbers">205</td><td class="ins"><ins>+						Xml::checkLabel( wfMsg( 'fix-double-redirects' ), 'wpFixRedirects', </ins></td></tr>
<tr id="241"><td class="linenumbers"> </td><td class="linenumbers">206</td><td class="ins"><ins>+							'wpFixRedirects', $this->fixRedirects ) .</ins></td></tr>
<tr id="242"><td class="linenumbers"> </td><td class="linenumbers">207</td><td class="ins"><ins>+					"&lt;/td></ins></td></tr>
<tr id="243"><td class="linenumbers"> </td><td class="linenumbers">208</td><td class="ins"><ins>+				&lt;/td>"</ins></td></tr>
<tr id="244"><td class="linenumbers"> </td><td class="linenumbers">209</td><td class="ins"><ins>+			);</ins></td></tr>
<tr id="245"><td class="linenumbers"> </td><td class="linenumbers">210</td><td class="ins"><ins>+		}</ins></td></tr>
<tr id="246"><td class="linenumbers"> </td><td class="linenumbers">211</td><td class="ins"><ins>+</ins></td></tr>
<tr id="247"><td class="linenumbers"> </td><td class="linenumbers">212</td><td class="ins"><ins>+		if( ($this->oldTitle->hasSubpages() || $this->oldTitle->getTalkPage()->hasSubpages())</ins></td></tr>
<tr id="248"><td class="linenumbers"> </td><td class="linenumbers">213</td><td class="ins"><ins>+		&amp;&amp; $this->oldTitle->userCan( 'move-subpages' ) ) {</ins></td></tr>
<tr id="249"><td class="linenumbers"> </td><td class="linenumbers">214</td><td class="ins"><ins>+			$wgOut->addHTML( "</ins></td></tr>
<tr id="250"><td class="linenumbers"> </td><td class="linenumbers">215</td><td class="ins"><ins>+				&lt;tr></ins></td></tr>
<tr id="251"><td class="linenumbers"> </td><td class="linenumbers">216</td><td class="ins"><ins>+					&lt;td>&lt;/td></ins></td></tr>
<tr id="252"><td class="linenumbers">199</td><td class="linenumbers">217</td><td class="unchanged"><span> 					&lt;td class=\"mw-input\">" .</span></td></tr>
<tr id="253"><td class="linenumbers">200</td><td class="linenumbers">218</td><td class="unchanged"><span> 				Xml::checkLabel( wfMsgHtml(</span></td></tr>
<tr id="254"><td class="linenumbers">201</td><td class="linenumbers"> </td><td class="del"><del>-						$ot->hasSubpages()</del></td></tr>
<tr id="255"><td class="linenumbers"> </td><td class="linenumbers">219</td><td class="ins"><ins>+						$this->oldTitle->hasSubpages()</ins></td></tr>
<tr id="256"><td class="linenumbers">202</td><td class="linenumbers">220</td><td class="unchanged"><span> 						? 'move-subpages'</span></td></tr>
<tr id="257"><td class="linenumbers">203</td><td class="linenumbers">221</td><td class="unchanged"><span> 						: 'move-talk-subpages'</span></td></tr>
<tr id="258"><td class="linenumbers">204</td><td class="linenumbers">222</td><td class="unchanged"><span> 					),</span></td></tr>
<tr id="259"><td class="linenumbers">205</td><td class="linenumbers">223</td><td class="unchanged"><span> 					'wpMovesubpages', 'wpMovesubpages',</span></td></tr>
<tr id="260"><td class="linenumbers">206</td><td class="linenumbers">224</td><td class="unchanged"><span> 					# Don't check the box if we only have talk subpages to</span></td></tr>
<tr id="261"><td class="linenumbers">207</td><td class="linenumbers">225</td><td class="unchanged"><span> 					# move and we aren't moving the talk page.</span></td></tr>
<tr id="262"><td class="linenumbers">208</td><td class="linenumbers"> </td><td class="del"><del>-					$this->moveSubpages &amp;&amp; ($ot->hasSubpages() || $this->moveTalk)</del></td></tr>
<tr id="263"><td class="linenumbers"> </td><td class="linenumbers">226</td><td class="ins"><ins>+					$this->moveSubpages &amp;&amp; ($this->oldTitle->hasSubpages() || $this->moveTalk)</ins></td></tr>
<tr id="264"><td class="linenumbers">209</td><td class="linenumbers">227</td><td class="unchanged"><span> 				) .</span></td></tr>
<tr id="265"><td class="linenumbers">210</td><td class="linenumbers">228</td><td class="unchanged"><span> 					"&lt;/td></span></td></tr>
<tr id="266"><td class="linenumbers">211</td><td class="linenumbers">229</td><td class="unchanged"><span> 				&lt;/tr>"</span></td></tr>
<tr id="267"><td class="linenumbers">212</td><td class="linenumbers">230</td><td class="unchanged"><span> 			);</span></td></tr>
<tr id="268"><td class="linenumbers">213</td><td class="linenumbers">231</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="269"><td class="linenumbers">214</td><td class="linenumbers">232</td><td class="unchanged"><span> </span></td></tr>
<tr id="270"><td class="linenumbers">215</td><td class="linenumbers"> </td><td class="del"><del>-		$watchChecked = $this->watch || $wgUser->getBoolOption( 'watchmoves' ) || $ot->userIsWatching();</del></td></tr>
<tr id="271"><td class="linenumbers"> </td><td class="linenumbers">233</td><td class="ins"><ins>+		$watchChecked = $this->watch || $wgUser->getBoolOption( 'watchmoves' ) </ins></td></tr>
<tr id="272"><td class="linenumbers"> </td><td class="linenumbers">234</td><td class="ins"><ins>+			|| $this->oldTitle->userIsWatching();</ins></td></tr>
<tr id="273"><td class="linenumbers">216</td><td class="linenumbers">235</td><td class="unchanged"><span> 		$wgOut->addHTML( "</span></td></tr>
<tr id="274"><td class="linenumbers">217</td><td class="linenumbers">236</td><td class="unchanged"><span> 			&lt;tr></span></td></tr>
<tr id="275"><td class="linenumbers">218</td><td class="linenumbers">237</td><td class="unchanged"><span> 				&lt;td>&lt;/td></span></td></tr>
<tr id="276"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -233,7 +252,7 @@</span></td></tr>
<tr id="277"><td class="linenumbers">234</td><td class="linenumbers">253</td><td class="unchanged"><span> 			"\n"</span></td></tr>
<tr id="278"><td class="linenumbers">235</td><td class="linenumbers">254</td><td class="unchanged"><span> 		);</span></td></tr>
<tr id="279"><td class="linenumbers">236</td><td class="linenumbers">255</td><td class="unchanged"><span> </span></td></tr>
<tr id="280"><td class="linenumbers">237</td><td class="linenumbers"> </td><td class="del"><del>-		$this->showLogFragment( $ot, $wgOut );</del></td></tr>
<tr id="281"><td class="linenumbers"> </td><td class="linenumbers">256</td><td class="ins"><ins>+		$this->showLogFragment( $this->oldTitle, $wgOut );</ins></td></tr>
<tr id="282"><td class="linenumbers">238</td><td class="linenumbers">257</td><td class="unchanged"><span> </span></td></tr>
<tr id="283"><td class="linenumbers">239</td><td class="linenumbers">258</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="284"><td class="linenumbers">240</td><td class="linenumbers">259</td><td class="unchanged"><span> </span></td></tr>
<tr id="285"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -277,6 +296,10 @@</span></td></tr>
<tr id="286"><td class="linenumbers">278</td><td class="linenumbers">297</td><td class="unchanged"><span> 			return;</span></td></tr>
<tr id="287"><td class="linenumbers">279</td><td class="linenumbers">298</td><td class="unchanged"><span> 		}</span></td></tr>
<tr id="288"><td class="linenumbers">280</td><td class="linenumbers">299</td><td class="unchanged"><span> </span></td></tr>
<tr id="289"><td class="linenumbers"> </td><td class="linenumbers">300</td><td class="ins"><ins>+		if ( $this->fixRedirects ) {</ins></td></tr>
<tr id="290"><td class="linenumbers"> </td><td class="linenumbers">301</td><td class="ins"><ins>+			DoubleRedirectJob::fixRedirects( 'move', $ot, $nt );</ins></td></tr>
<tr id="291"><td class="linenumbers"> </td><td class="linenumbers">302</td><td class="ins"><ins>+		}</ins></td></tr>
<tr id="292"><td class="linenumbers"> </td><td class="linenumbers">303</td><td class="ins"><ins>+</ins></td></tr>
<tr id="293"><td class="linenumbers">281</td><td class="linenumbers">304</td><td class="unchanged"><span> 		wfRunHooks( 'SpecialMovepageAfterMove', array( &amp;$this , &amp;$ot , &amp;$nt ) )	;</span></td></tr>
<tr id="294"><td class="linenumbers">282</td><td class="linenumbers">305</td><td class="unchanged"><span> </span></td></tr>
<tr id="295"><td class="linenumbers">283</td><td class="linenumbers">306</td><td class="unchanged"><span> 		$wgOut->setPagetitle( wfMsg( 'pagemovedsub' ) );</span></td></tr>
<tr id="296"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -358,40 +381,43 @@</span></td></tr>
<tr id="297"><td class="linenumbers">359</td><td class="linenumbers">382</td><td class="unchanged"><span> 				continue;</span></td></tr>
<tr id="298"><td class="linenumbers">360</td><td class="linenumbers">383</td><td class="unchanged"><span> 			}</span></td></tr>
<tr id="299"><td class="linenumbers">361</td><td class="linenumbers">384</td><td class="unchanged"><span> </span></td></tr>
<tr id="300"><td class="linenumbers">362</td><td class="linenumbers"> </td><td class="del"><del>-			$oldPage = Title::newFromRow( $row );</del></td></tr>
<tr id="301"><td class="linenumbers"> </td><td class="linenumbers">385</td><td class="ins"><ins>+			$oldSubpage = Title::newFromRow( $row );</ins></td></tr>
<tr id="302"><td class="linenumbers">363</td><td class="linenumbers">386</td><td class="unchanged"><span> 			$newPageName = preg_replace(</span></td></tr>
<tr id="303"><td class="linenumbers">364</td><td class="linenumbers">387</td><td class="unchanged"><span> 				'#^'.preg_quote( $ot->getDBKey(), '#' ).'#',</span></td></tr>
<tr id="304"><td class="linenumbers">365</td><td class="linenumbers">388</td><td class="unchanged"><span> 				$nt->getDBKey(),</span></td></tr>
<tr id="305"><td class="linenumbers">366</td><td class="linenumbers"> </td><td class="del"><del>-				$oldPage->getDBKey()</del></td></tr>
<tr id="306"><td class="linenumbers"> </td><td class="linenumbers">389</td><td class="ins"><ins>+				$oldSubpage->getDBKey()</ins></td></tr>
<tr id="307"><td class="linenumbers">367</td><td class="linenumbers">390</td><td class="unchanged"><span> 			);</span></td></tr>
<tr id="308"><td class="linenumbers">368</td><td class="linenumbers"> </td><td class="del"><del>-			if( $oldPage->isTalkPage() ) {</del></td></tr>
<tr id="309"><td class="linenumbers"> </td><td class="linenumbers">391</td><td class="ins"><ins>+			if( $oldSubpage->isTalkPage() ) {</ins></td></tr>
<tr id="310"><td class="linenumbers">369</td><td class="linenumbers">392</td><td class="unchanged"><span> 				$newNs = $nt->getTalkPage()->getNamespace();</span></td></tr>
<tr id="311"><td class="linenumbers">370</td><td class="linenumbers">393</td><td class="unchanged"><span> 			} else {</span></td></tr>
<tr id="312"><td class="linenumbers">371</td><td class="linenumbers">394</td><td class="unchanged"><span> 				$newNs = $nt->getSubjectPage()->getNamespace();</span></td></tr>
<tr id="313"><td class="linenumbers">372</td><td class="linenumbers">395</td><td class="unchanged"><span> 			}</span></td></tr>
<tr id="314"><td class="linenumbers">373</td><td class="linenumbers">396</td><td class="unchanged"><span> 			# Bug 14385: we need makeTitleSafe because the new page names may</span></td></tr>
<tr id="315"><td class="linenumbers">374</td><td class="linenumbers">397</td><td class="unchanged"><span> 			# be longer than 255 characters.</span></td></tr>
<tr id="316"><td class="linenumbers">375</td><td class="linenumbers"> </td><td class="del"><del>-			$newPage = Title::makeTitleSafe( $newNs, $newPageName );</del></td></tr>
<tr id="317"><td class="linenumbers">376</td><td class="linenumbers"> </td><td class="del"><del>-			if( !$newPage ) {</del></td></tr>
<tr id="318"><td class="linenumbers">377</td><td class="linenumbers"> </td><td class="del"><del>-				$oldLink = $skin->makeKnownLinkObj( $oldPage );</del></td></tr>
<tr id="319"><td class="linenumbers"> </td><td class="linenumbers">398</td><td class="ins"><ins>+			$newSubpage = Title::makeTitleSafe( $newNs, $newPageName );</ins></td></tr>
<tr id="320"><td class="linenumbers"> </td><td class="linenumbers">399</td><td class="ins"><ins>+			if( !$newSubpage ) {</ins></td></tr>
<tr id="321"><td class="linenumbers"> </td><td class="linenumbers">400</td><td class="ins"><ins>+				$oldLink = $skin->makeKnownLinkObj( $oldSubpage );</ins></td></tr>
<tr id="322"><td class="linenumbers">378</td><td class="linenumbers">401</td><td class="unchanged"><span> 				$extraOutput []= wfMsgHtml( 'movepage-page-unmoved', $oldLink,</span></td></tr>
<tr id="323"><td class="linenumbers">379</td><td class="linenumbers">402</td><td class="unchanged"><span> 					htmlspecialchars(Title::makeName( $newNs, $newPageName )));</span></td></tr>
<tr id="324"><td class="linenumbers">380</td><td class="linenumbers">403</td><td class="unchanged"><span> 				continue;</span></td></tr>
<tr id="325"><td class="linenumbers">381</td><td class="linenumbers">404</td><td class="unchanged"><span> 			}</span></td></tr>
<tr id="326"><td class="linenumbers">382</td><td class="linenumbers">405</td><td class="unchanged"><span> </span></td></tr>
<tr id="327"><td class="linenumbers">383</td><td class="linenumbers">406</td><td class="unchanged"><span> 			# This was copy-pasted from Renameuser, bleh.</span></td></tr>
<tr id="328"><td class="linenumbers">384</td><td class="linenumbers"> </td><td class="del"><del>-			if ( $newPage->exists() &amp;&amp; !$oldPage->isValidMoveTarget( $newPage ) ) {</del></td></tr>
<tr id="329"><td class="linenumbers">385</td><td class="linenumbers"> </td><td class="del"><del>-				$link = $skin->makeKnownLinkObj( $newPage );</del></td></tr>
<tr id="330"><td class="linenumbers"> </td><td class="linenumbers">407</td><td class="ins"><ins>+			if ( $newSubpage->exists() &amp;&amp; !$oldSubpage->isValidMoveTarget( $newSubpage ) ) {</ins></td></tr>
<tr id="331"><td class="linenumbers"> </td><td class="linenumbers">408</td><td class="ins"><ins>+				$link = $skin->makeKnownLinkObj( $newSubpage );</ins></td></tr>
<tr id="332"><td class="linenumbers">386</td><td class="linenumbers">409</td><td class="unchanged"><span> 				$extraOutput []= wfMsgHtml( 'movepage-page-exists', $link );</span></td></tr>
<tr id="333"><td class="linenumbers">387</td><td class="linenumbers">410</td><td class="unchanged"><span> 			} else {</span></td></tr>
<tr id="334"><td class="linenumbers">388</td><td class="linenumbers"> </td><td class="del"><del>-				$success = $oldPage->moveTo( $newPage, true, $this->reason );</del></td></tr>
<tr id="335"><td class="linenumbers"> </td><td class="linenumbers">411</td><td class="ins"><ins>+				$success = $oldSubpage->moveTo( $newSubpage, true, $this->reason );</ins></td></tr>
<tr id="336"><td class="linenumbers">389</td><td class="linenumbers">412</td><td class="unchanged"><span> 				if( $success === true ) {</span></td></tr>
<tr id="337"><td class="linenumbers">390</td><td class="linenumbers"> </td><td class="del"><del>-					$oldLink = $skin->makeKnownLinkObj( $oldPage, '', 'redirect=no' );</del></td></tr>
<tr id="338"><td class="linenumbers">391</td><td class="linenumbers"> </td><td class="del"><del>-					$newLink = $skin->makeKnownLinkObj( $newPage );</del></td></tr>
<tr id="339"><td class="linenumbers"> </td><td class="linenumbers">413</td><td class="ins"><ins>+					if ( $this->fixRedirects ) {</ins></td></tr>
<tr id="340"><td class="linenumbers"> </td><td class="linenumbers">414</td><td class="ins"><ins>+						DoubleRedirectJob::fixRedirects( 'move', $oldSubpage, $newSubpage );</ins></td></tr>
<tr id="341"><td class="linenumbers"> </td><td class="linenumbers">415</td><td class="ins"><ins>+					}</ins></td></tr>
<tr id="342"><td class="linenumbers"> </td><td class="linenumbers">416</td><td class="ins"><ins>+					$oldLink = $skin->makeKnownLinkObj( $oldSubpage, '', 'redirect=no' );</ins></td></tr>
<tr id="343"><td class="linenumbers"> </td><td class="linenumbers">417</td><td class="ins"><ins>+					$newLink = $skin->makeKnownLinkObj( $newSubpage );</ins></td></tr>
<tr id="344"><td class="linenumbers">392</td><td class="linenumbers">418</td><td class="unchanged"><span> 					$extraOutput []= wfMsgHtml( 'movepage-page-moved', $oldLink, $newLink );</span></td></tr>
<tr id="345"><td class="linenumbers">393</td><td class="linenumbers">419</td><td class="unchanged"><span> 				} else {</span></td></tr>
<tr id="346"><td class="linenumbers">394</td><td class="linenumbers"> </td><td class="del"><del>-					$oldLink = $skin->makeKnownLinkObj( $oldPage );</del></td></tr>
<tr id="347"><td class="linenumbers">395</td><td class="linenumbers"> </td><td class="del"><del>-					$newLink = $skin->makeLinkObj( $newPage );</del></td></tr>
<tr id="348"><td class="linenumbers"> </td><td class="linenumbers">420</td><td class="ins"><ins>+					$oldLink = $skin->makeKnownLinkObj( $oldSubpage );</ins></td></tr>
<tr id="349"><td class="linenumbers"> </td><td class="linenumbers">421</td><td class="ins"><ins>+					$newLink = $skin->makeLinkObj( $newSubpage );</ins></td></tr>
<tr id="350"><td class="linenumbers">396</td><td class="linenumbers">422</td><td class="unchanged"><span> 					$extraOutput []= wfMsgHtml( 'movepage-page-unmoved', $oldLink, $newLink );</span></td></tr>
<tr id="351"><td class="linenumbers">397</td><td class="linenumbers">423</td><td class="unchanged"><span> 				}</span></td></tr>
<tr id="352"><td class="linenumbers">398</td><td class="linenumbers">424</td><td class="unchanged"><span> 			}</span></td></tr>
<tr id="353" class="patchedfile"><td colspan="3">Index: trunk/phase3/RELEASE-NOTES</td></tr>



<tr id="357"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -194,6 +194,7 @@</span></td></tr>
<tr id="358"><td class="linenumbers">195</td><td class="linenumbers">195</td><td class="unchanged"><span> * Special:Recentchangeslinked now includes changes to transcluded pages and</span></td></tr>
<tr id="359"><td class="linenumbers">196</td><td class="linenumbers">196</td><td class="unchanged"><span>   displayed images; also, the "Show changes to pages linked" checkbox now works on</span></td></tr>
<tr id="360"><td class="linenumbers">197</td><td class="linenumbers">197</td><td class="unchanged"><span>   category pages too, showing all links that are not categorizations</span></td></tr>
<tr id="361"><td class="linenumbers"> </td><td class="linenumbers">198</td><td class="ins"><ins>+* (bug 4578) Automatically fix redirects broken by a page move </ins></td></tr>
<tr id="362"><td class="linenumbers">198</td><td class="linenumbers">199</td><td class="unchanged"><span> </span></td></tr>
<tr id="363"><td class="linenumbers">199</td><td class="linenumbers">200</td><td class="unchanged"><span> === Bug fixes in 1.13 ===</span></td></tr>
<tr id="364"><td class="linenumbers">200</td><td class="linenumbers">201</td><td class="unchanged"><span> </span></td></tr>
<tr id="365" class="patchedfile"><td colspan="3">Index: trunk/phase3/languages/messages/MessagesEn.php</td></tr>



<tr id="369"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -1871,6 +1871,9 @@</span></td></tr>
<tr id="370"><td class="linenumbers">1872</td><td class="linenumbers">1872</td><td class="unchanged"><span> 'doubleredirectstext'     => 'This page lists pages which redirect to other redirect pages.</span></td></tr>
<tr id="371"><td class="linenumbers">1873</td><td class="linenumbers">1873</td><td class="unchanged"><span> Each row contains links to the first and second redirect, as well as the target of the second redirect, which is usually "real" target page, which the first redirect should point to.',</span></td></tr>
<tr id="372"><td class="linenumbers">1874</td><td class="linenumbers">1874</td><td class="unchanged"><span> </span></td></tr>
<tr id="373"><td class="linenumbers"> </td><td class="linenumbers">1875</td><td class="ins"><ins>+'double-redirect-fixed-move'   => '[[$1]] has been moved, it is now just a redirect to [[$2]]',</ins></td></tr>
<tr id="374"><td class="linenumbers"> </td><td class="linenumbers">1876</td><td class="ins"><ins>+'double-redirect-fixer'   => 'Redirect fixer',</ins></td></tr>
<tr id="375"><td class="linenumbers"> </td><td class="linenumbers">1877</td><td class="ins"><ins>+</ins></td></tr>
<tr id="376"><td class="linenumbers">1875</td><td class="linenumbers">1878</td><td class="unchanged"><span> 'brokenredirects'         => 'Broken redirects',</span></td></tr>
<tr id="377"><td class="linenumbers">1876</td><td class="linenumbers">1879</td><td class="unchanged"><span> 'brokenredirects-summary' => '', # do not translate or duplicate this message to other languages</span></td></tr>
<tr id="378"><td class="linenumbers">1877</td><td class="linenumbers">1880</td><td class="unchanged"><span> 'brokenredirectstext'     => 'The following redirects link to non-existent pages:',</span></td></tr>
<tr id="379"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -2500,6 +2503,7 @@</span></td></tr>
<tr id="380"><td class="linenumbers">2501</td><td class="linenumbers">2504</td><td class="unchanged"><span> 'imagenocrossnamespace'   => 'Cannot move file to non-file namespace',</span></td></tr>
<tr id="381"><td class="linenumbers">2502</td><td class="linenumbers">2505</td><td class="unchanged"><span> 'imagetypemismatch'       => 'The new file extension does not match its type',</span></td></tr>
<tr id="382"><td class="linenumbers">2503</td><td class="linenumbers">2506</td><td class="unchanged"><span> 'imageinvalidfilename'    => 'The target file name is invalid',</span></td></tr>
<tr id="383"><td class="linenumbers"> </td><td class="linenumbers">2507</td><td class="ins"><ins>+'fix-double-redirects'    => 'Update any redirects that point to the original title',</ins></td></tr>
<tr id="384"><td class="linenumbers">2504</td><td class="linenumbers">2508</td><td class="unchanged"><span> </span></td></tr>
<tr id="385"><td class="linenumbers">2505</td><td class="linenumbers">2509</td><td class="unchanged"><span> # Export</span></td></tr>
<tr id="386"><td class="linenumbers">2506</td><td class="linenumbers">2510</td><td class="unchanged"><span> 'export'            => 'Export pages',</span></td></tr>
</table>
</div>
<h2 id='code-references'>Follow-up revisions</h2>
<table border='1' class='wikitable'><tr><th>Revision</th><th>Commit summary</th><th>Author</th><th>Date</th></tr><tr class='mw-codereview-status-old'><td><a href="./37940.html" title="Special:Code/MediaWiki/37940">r37940</a></td><td>Fix for <a href="./37928.html" title="Special:Code/MediaWiki/37928">r37928</a>....</td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki/author/siebrand" title="Special:Code/MediaWiki/author/siebrand">siebrand</a></td><td>08:39, 23 July 2008</td></tr>
<tr class='mw-codereview-status-old'><td><a href="./37942.html" title="Special:Code/MediaWiki/37942">r37942</a></td><td>Missing file for <a href="./37928.html" title="Special:Code/MediaWiki/37928">r37928</a></td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki/author/tstarling" title="Special:Code/MediaWiki/author/tstarling">tstarling</a></td><td>08:48, 23 July 2008</td></tr></table><h2 id='code-referenced'>Past revisions this follows-up on</h2>
<table border='1' class='wikitable'><tr><th>Revision</th><th>Commit summary</th><th>Author</th><th>Date</th></tr><tr class='mw-codereview-status-old'><td><a href="./12647.html" title="Special:Code/MediaWiki/12647">r12647</a></td><td>Update copyright year to extend to 2006 in a couple of visible places, per <a class="external" href="https://bugzilla.wikimedia.org/show_bug.cgi?id=4578">bu...</a></td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki/author/robchurch" title="Special:Code/MediaWiki/author/robchurch">robchurch</a></td><td>13:56, 13 January 2006</td></tr></table><h2 id='code-changes'>Status &amp; tagging log</h2>
<ul class='mw-codereview-changes'><li>15:29, 12 September 2011&#160;<a href="https://www.mediawiki.org/wiki/User:Meno25" class="mw-userlink" title="User:Meno25"><bdi>Meno25</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Meno25" class="mw-usertoollinks-talk" title="User talk:Meno25">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Meno25" class="mw-usertoollinks-contribs" title="Special:Contributions/Meno25">contribs</a>)</span>&#160;changed the <b>status</b> of r37928 <i>[<b>removed:</b> ok&#160;<b>added:</b> old]</i></li></ul></form></div>
</body>
</html>
 contentType 9 text/html url 64 https://static-codereview.wikimedia.org:443/MediaWiki/37928.html responseCode 3 200 