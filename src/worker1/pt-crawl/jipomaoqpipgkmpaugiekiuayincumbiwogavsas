jipomaoqpipgkmpaugiekiuayincumbiwogavsas length 5 15333 page 15333 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wikibase: Item &amp; Property Terms</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Wikibase
   </div>
   <div id="projectbrief">MediaWiki Wikibase extension</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('docs_storage_terms.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Item &amp; Property Terms</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_docs_2storage_2terms"></a> Secondary storage for Item and Property terms in SQL is needed for efficient and atomic lookup and query of the terms of multiple entities in multiple languages.</p>
<p>For example, when rendering an Item page the labels of all other entities being referred to need to be known. The alternative to secondary storage would be loading each of the full entities in order to lookup the terms needed.</p>
<p>The code for the storage lives in the <a class="el" href="namespaceWikibase_1_1Lib_1_1Store_1_1Sql_1_1Terms.html">Wikibase\Lib\Store\Sql\Terms</a> namespace.</p>
<p>Writing to the secondary storage happens through a deferred update after each edit on entities. This is to make saving edits faster and more atomic which also means reducing the failure rate of saving edits. As the result, secondary storage might not be always completely in sync with the actual terms stored in the primary storage.</p>
<p>Briefly in code:</p><ul>
<li>ItemTermStoreWriter and PropertyTermStoreWriter are the interfaces at the bottom of the term storage tree.<ul>
<li>These interfaces are provided by the <code>data-model-services</code> vendor component</li>
</ul>
</li>
<li><a class="el" href="interfaceWikibase_1_1Lib_1_1Store_1_1EntityTermStoreWriter.html">EntityTermStoreWriter</a> joins these stores in an interface that can generically save either Item or Property terms.</li>
</ul>
<h2><a class="anchor" id="autotoc_md169"></a>
Secondary Storage</h2>
<p>The storage is made up of multiple normalized tables, all prefixed with "wbt_".DatabaseTermInLangIdsAcquirer The tables were created by <a class="el" href="sqlite_2term__store_8sql.html">term_store.sql</a> which includes some documentation.</p>
<ul>
<li><a class="el" href="docs_sql_wbt_item_terms.html">wbt_item_terms</a></li>
<li><a class="el" href="docs_sql_wbt_property_terms.html">wbt_property_terms</a></li>
<li><a class="el" href="docs_sql_wbt_term_in_lang.html">wbt_term_in_lang</a></li>
<li><a class="el" href="docs_sql_wbt_text_in_lang.html">wbt_text_in_lang</a></li>
<li><a class="el" href="docs_sql_wbt_type.html">wbt_type</a></li>
<li><a class="el" href="docs_sql_wbt_text.html">wbt_text</a></li>
</ul>
<p>The relations are shown below:</p>
<div class="dotgraph">
<img src="dot_inline_dotgraph_3.png" alt="dot_inline_dotgraph_3.png" border="0" usemap="#dot_inline_dotgraph_3.map"/>
</div>
<p>The Normalization results in a more complex query and update pattern. See sections below for more details on how Reading and Updating work.</p>
<h3><a class="anchor" id="autotoc_md170"></a>
Read queries</h3>
<p><b>Lookup terms of an entity</b></p>
<p>Lookup of the terms of an entity can be achieved by starting with the <a class="el" href="docs_sql_wbt_item_terms.html">wbt_item_terms</a> or <a class="el" href="docs_sql_wbt_property_terms.html">wbt_property_terms</a> tables where you will find integer representations of Item and Property identifiers.</p>
<p>The below query selects all terms in the tables for item Q123 and can be used as a starting point for data exploration:</p>
<div class="fragment"><div class="line"><span class="keyword">SELECT</span></div>
<div class="line">  wbit_item_id <span class="keyword">as</span> id,</div>
<div class="line">  wby_name <span class="keyword">as</span> type,</div>
<div class="line">  wbxl_language <span class="keyword">as</span> <span class="keyword">language</span>,</div>
<div class="line">  wbx_text <span class="keyword">as</span> text</div>
<div class="line"><span class="keyword">FROM</span> wbt_item_terms</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_term_in_lang <span class="keyword">ON</span> wbit_term_in_lang_id = wbtl_id</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_type <span class="keyword">ON</span> wbtl_type_id = wby_id</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_text_in_lang <span class="keyword">ON</span> wbtl_text_in_lang_id = wbxl_id</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_text <span class="keyword">ON</span> wbxl_text_id = wbx_id</div>
<div class="line"><span class="keyword">WHERE</span> wbit_item_id = <span class="stringliteral">123</span>;</div>
</div><!-- fragment --><p>For properties you can do something like:</p>
<div class="fragment"><div class="line"><span class="keyword">SELECT</span></div>
<div class="line">  wbpt_property_id <span class="keyword">as</span> id,</div>
<div class="line">  wby_name <span class="keyword">as</span> type,</div>
<div class="line">  wbxl_language <span class="keyword">as</span> <span class="keyword">language</span>,</div>
<div class="line">  wbx_text <span class="keyword">as</span> text</div>
<div class="line"><span class="keyword">FROM</span> wbt_property_terms</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_term_in_lang <span class="keyword">ON</span> wbpt_term_in_lang_id = wbtl_id</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_type <span class="keyword">ON</span> wbtl_type_id = wby_id</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_text_in_lang <span class="keyword">ON</span> wbtl_text_in_lang_id = wbxl_id</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_text <span class="keyword">ON</span> wbxl_text_id = wbx_id</div>
<div class="line"><span class="keyword">WHERE</span> wbpt_property_id = <span class="stringliteral">10</span>;</div>
</div><!-- fragment --><p><b>Lookup all entities that use a certain term</b></p>
<p>Lookup of entities from a term string can be achieved by starting with the <a class="el" href="docs_sql_wbt_text.html">wbt_text</a> table which contains the text for all terms or all types for both Items and Properties.</p>
<div class="fragment"><div class="line"><span class="keyword">SELECT</span></div>
<div class="line">  wbit_item_id <span class="keyword">as</span> id,</div>
<div class="line">  wby_name <span class="keyword">as</span> type,</div>
<div class="line">  wbxl_language <span class="keyword">as</span> <span class="keyword">language</span>,</div>
<div class="line">  wbx_text <span class="keyword">as</span> text</div>
<div class="line"><span class="keyword">FROM</span> wbt_item_terms</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_term_in_lang <span class="keyword">ON</span> wbit_term_in_lang_id = wbtl_id</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_type <span class="keyword">ON</span> wbtl_type_id = wby_id</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_text_in_lang <span class="keyword">ON</span> wbtl_text_in_lang_id = wbxl_id</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_text <span class="keyword">ON</span> wbxl_text_id = wbx_id</div>
<div class="line"><span class="keyword">WHERE</span> wby_name = <span class="stringliteral">&#39;label&#39;</span></div>
<div class="line"><span class="keyword">AND</span> wbxl_language = <span class="stringliteral">&#39;en&#39;</span></div>
<div class="line"><span class="keyword">AND</span> wbx_text = <span class="stringliteral">&#39;Berlin&#39;</span>;</div>
</div><!-- fragment --><p>For properties you can do something like:</p>
<div class="fragment"><div class="line"><span class="keyword">SELECT</span></div>
<div class="line">  wbpt_property_id <span class="keyword">as</span> id,</div>
<div class="line">  wby_name <span class="keyword">as</span> type,</div>
<div class="line">  wbxl_language <span class="keyword">as</span> <span class="keyword">language</span>,</div>
<div class="line">  wbx_text <span class="keyword">as</span> text</div>
<div class="line"><span class="keyword">FROM</span> wbt_property_terms</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_term_in_lang <span class="keyword">ON</span> wbpt_term_in_lang_id = wbtl_id</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_type <span class="keyword">ON</span> wbtl_type_id = wby_id</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_text_in_lang <span class="keyword">ON</span> wbtl_text_in_lang_id = wbxl_id</div>
<div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> wbt_text <span class="keyword">ON</span> wbxl_text_id = wbx_id</div>
<div class="line"><span class="keyword">WHERE</span> wby_name = <span class="stringliteral">&#39;label&#39;</span></div>
<div class="line"><span class="keyword">AND</span> wbxl_language = <span class="stringliteral">&#39;en&#39;</span></div>
<div class="line"><span class="keyword">AND</span> wbx_text = <span class="stringliteral">&#39;instance of&#39;</span>;</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md171"></a>
Updating</h3>
<p><b>Process outline</b></p>
<ul>
<li>Term secondary storage is currently written to after edits are saved in MediaWiki's "Secondary data updates". See ItemHandler::getSecondaryDataUpdates() and PropertyHandler::getSecondaryDataUpdates() implementations.</li>
<li>When term changes happen a series of ID acquisitions occur in <a class="el" href="classWikibase_1_1Lib_1_1Store_1_1Sql_1_1Terms_1_1DatabaseTermInLangIdsAcquirer.html">DatabaseTermInLangIdsAcquirer</a>. (Finding IDs that already exist in the storage that will be needed for future inserts)</li>
<li>When new terms are being introduced rows that do not appear in the acquisition will be inserted.</li>
<li>Actual insertion and deletion of the terms in the <code>wbt_item_terms</code> and <code>wbt_property_terms</code> tables is done in <a class="el" href="classWikibase_1_1Lib_1_1Store_1_1Sql_1_1Terms_1_1DatabaseItemTermStoreWriter.html">DatabaseItemTermStoreWriter</a> and <a class="el" href="classWikibase_1_1Lib_1_1Store_1_1Sql_1_1Terms_1_1DatabasePropertyTermStoreWriter.html">DatabasePropertyTermStoreWriter</a>.</li>
<li>When term changes result in some terms potentially being no longer being used across the whole store a <a class="el" href="classWikibase_1_1Lib_1_1Store_1_1Sql_1_1Terms_1_1CleanTermsIfUnusedJob.html">CleanTermsIfUnusedJob</a> job will be scheduled to remove the rows.</li>
<li>The job removes data from other tables using a <a class="el" href="classWikibase_1_1Lib_1_1Store_1_1Sql_1_1Terms_1_1DatabaseInnerTermStoreCleaner.html">DatabaseInnerTermStoreCleaner</a>.</li>
</ul>
<p><b>Keeping the store clean</b></p>
<p>The tables in the store are cleaned up so that data that is totally removed from entities is also totally removed from the store. This is important for cases such as Wikidata that has publicly accessible database replicas of this information. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Wikibase</a></li><li class="navelem"><a class="el" href="docs_topics_index.html">Topics</a></li><li class="navelem"><a class="el" href="docs_topics_storage.html">Storage</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
 contentType 9 text/html url 73 https://doc.wikimedia.org:443/Wikibase/master/php/docs_storage_terms.html responseCode 3 200 