vefazexmbguqgqxqkqvglqwoaofmeqrakmsinmfk length 5 20538 page 20538 
<html>
<head>
<title>r45734 MediaWiki - Code Review archive</title>
<meta charset="utf-8">
<link rel="stylesheet" href="../ext.codereview.styles.css"/>
</head>
<body>
<h1>r45734 MediaWiki - Code Review archive</h1>
<div id="mw-content-text" class="mw-body-content"><form action="/wiki/Special:Code/MediaWiki/45734" method="post"><table class="mw-codereview-meta"><tr><td>Repository:</td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki" title="Special:Code/MediaWiki">MediaWiki</a></td></tr>
<tr><td>Revision:</td><td>&lt;&#160;<a href="./45733.html" title="Special:Code/MediaWiki/45733">r45733</a>‎ | <b>r45734</b> | <a href="./45735.html" title="Special:Code/MediaWiki/45735">r45735</a>&#160;&gt;</td></tr>
<tr><td>Date:</td><td>17:54, 14 January 2009</td></tr>
<tr><td>Author:</td><td><a href="https://www.mediawiki.org/wiki/Special:Code/MediaWiki/author/simetrical" title="Special:Code/MediaWiki/author/simetrical">simetrical</a></td></tr>
<tr><td>Status:</td><td>ok (<a href="#code-comments">Comments</a>)
</td></tr>
<tr><td>Tags:</td><td></td></tr>
<tr><td>Comment:</td><td><div class="mw-codereview-message">(<a class="external" href="https://bugzilla.wikimedia.org/show_bug.cgi?id=16852">bug 16852</a>) padleft and padright now handle multibyte characters and multicharacter pad strings<br />
<br />
Patch by RememberTheDot, with adjustments to comments by me</div></td></tr>
<tr><td>Modified paths:</td><td><div class='mw-codereview-paths mw-content-ltr'><ul>
<li><b>/trunk/phase3/RELEASE-NOTES</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2FRELEASE-NOTES" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/includes/parser/CoreParserFunctions.php</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fincludes%2Fparser%2FCoreParserFunctions.php" title="Special:Code/MediaWiki">history</a>)</li>
<li><b>/trunk/phase3/maintenance/parserTests.txt</b> (modified) (<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki&amp;path=%2Ftrunk%2Fphase3%2Fmaintenance%2FparserTests.txt" title="Special:Code/MediaWiki">history</a>)</li>
</ul></div>
</td></tr>
</table>
<h2>Diff <small>[<a href="https://www.mediawiki.org/w/index.php?title=Special:Code/MediaWiki/45734&amp;action=purge" title="Special:Code/MediaWiki/45734">purge</a>]</small></h2><div class='mw-codereview-diff' id='mw-codereview-diff'><table class="mw-codereview-diff"><tr id="1" class="patchedfile"><td colspan="3">Index: trunk/phase3/RELEASE-NOTES</td></tr>



<tr id="5"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -34,7 +34,9 @@</span></td></tr>
<tr id="6"><td class="linenumbers">35</td><td class="linenumbers">35</td><td class="unchanged"><span> * Added "__\" magic word to eat up all whitespace and newlines to the next </span></td></tr>
<tr id="7"><td class="linenumbers">36</td><td class="linenumbers">36</td><td class="unchanged"><span>   non-whitespace character, to facilitate writing readable template code where</span></td></tr>
<tr id="8"><td class="linenumbers">37</td><td class="linenumbers">37</td><td class="unchanged"><span>   whitespace is significant. </span></td></tr>
<tr id="9"><td class="linenumbers">38</td><td class="linenumbers"> </td><td class="del"><del>-* (bug 17002) Add &amp;minor= and &amp;summary= as parameters in the url when editing, to automatically add a summary or a minor edit.</del></td></tr>
<tr id="10"><td class="linenumbers"> </td><td class="linenumbers">38</td><td class="ins"><ins>+* (bug 17002) Add &amp;minor= and &amp;summary= as parameters in the url when editing,</ins></td></tr>
<tr id="11"><td class="linenumbers"> </td><td class="linenumbers">39</td><td class="ins"><ins>+  to automatically add a summary or a minor edit.</ins></td></tr>
<tr id="12"><td class="linenumbers"> </td><td class="linenumbers">40</td><td class="ins"><ins>+* (bug 16852) padleft and padright now accept multiletter pad characters</ins></td></tr>
<tr id="13"><td class="linenumbers">39</td><td class="linenumbers">41</td><td class="unchanged"><span>   </span></td></tr>
<tr id="14"><td class="linenumbers">40</td><td class="linenumbers">42</td><td class="unchanged"><span> === Bug fixes in 1.15 ===</span></td></tr>
<tr id="15"><td class="linenumbers">41</td><td class="linenumbers">43</td><td class="unchanged"><span> * Fixing the caching issue by using -{T|xxx}- syntax (only applies on wiki with LanguageConverter class)</span></td></tr>
<tr id="16"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -42,6 +44,7 @@</span></td></tr>
<tr id="17"><td class="linenumbers">43</td><td class="linenumbers">45</td><td class="unchanged"><span> * (bug 16968) Special:Upload no longer throws useless warnings.</span></td></tr>
<tr id="18"><td class="linenumbers">44</td><td class="linenumbers">46</td><td class="unchanged"><span> * (bug 15470) Special:Upload no longer force-capitalizes titles</span></td></tr>
<tr id="19"><td class="linenumbers">45</td><td class="linenumbers">47</td><td class="unchanged"><span> * (bug 17000) Special:RevisionDelete now checks if the database is locked before trying to delete the edit.</span></td></tr>
<tr id="20"><td class="linenumbers"> </td><td class="linenumbers">48</td><td class="ins"><ins>+* (bug 16852) padleft and padright now handle multibyte characters correctly</ins></td></tr>
<tr id="21"><td class="linenumbers">46</td><td class="linenumbers">49</td><td class="unchanged"><span> </span></td></tr>
<tr id="22"><td class="linenumbers">47</td><td class="linenumbers">50</td><td class="unchanged"><span> == API changes in 1.15 ==</span></td></tr>
<tr id="23"><td class="linenumbers">48</td><td class="linenumbers">51</td><td class="unchanged"><span> * (bug 16798) JSON encoding errors for some characters outside the BMP</span></td></tr>
<tr id="24" class="patchedfile"><td colspan="3">Index: trunk/phase3/maintenance/parserTests.txt</td></tr>



<tr id="28"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -7233,6 +7233,24 @@</span></td></tr>
<tr id="29"><td class="linenumbers">7234</td><td class="linenumbers">7234</td><td class="unchanged"><span> &lt;/p></span></td></tr>
<tr id="30"><td class="linenumbers">7235</td><td class="linenumbers">7235</td><td class="unchanged"><span> !! end</span></td></tr>
<tr id="31"><td class="linenumbers">7236</td><td class="linenumbers">7236</td><td class="unchanged"><span> </span></td></tr>
<tr id="32"><td class="linenumbers"> </td><td class="linenumbers">7237</td><td class="ins"><ins>+!! test</ins></td></tr>
<tr id="33"><td class="linenumbers"> </td><td class="linenumbers">7238</td><td class="ins"><ins>+Multibyte character in padleft</ins></td></tr>
<tr id="34"><td class="linenumbers"> </td><td class="linenumbers">7239</td><td class="ins"><ins>+!! input</ins></td></tr>
<tr id="35"><td class="linenumbers"> </td><td class="linenumbers">7240</td><td class="ins"><ins>+{{padleft:-Hello|7|Æ}}</ins></td></tr>
<tr id="36"><td class="linenumbers"> </td><td class="linenumbers">7241</td><td class="ins"><ins>+!! result</ins></td></tr>
<tr id="37"><td class="linenumbers"> </td><td class="linenumbers">7242</td><td class="ins"><ins>+&lt;p>Æ-Hello</ins></td></tr>
<tr id="38"><td class="linenumbers"> </td><td class="linenumbers">7243</td><td class="ins"><ins>+&lt;/p></ins></td></tr>
<tr id="39"><td class="linenumbers"> </td><td class="linenumbers">7244</td><td class="ins"><ins>+!! end</ins></td></tr>
<tr id="40"><td class="linenumbers"> </td><td class="linenumbers">7245</td><td class="ins"><ins>+</ins></td></tr>
<tr id="41"><td class="linenumbers"> </td><td class="linenumbers">7246</td><td class="ins"><ins>+!! test</ins></td></tr>
<tr id="42"><td class="linenumbers"> </td><td class="linenumbers">7247</td><td class="ins"><ins>+Multibyte character in padright</ins></td></tr>
<tr id="43"><td class="linenumbers"> </td><td class="linenumbers">7248</td><td class="ins"><ins>+!! input</ins></td></tr>
<tr id="44"><td class="linenumbers"> </td><td class="linenumbers">7249</td><td class="ins"><ins>+{{padright:Hello-|7|Æ}}</ins></td></tr>
<tr id="45"><td class="linenumbers"> </td><td class="linenumbers">7250</td><td class="ins"><ins>+!! result</ins></td></tr>
<tr id="46"><td class="linenumbers"> </td><td class="linenumbers">7251</td><td class="ins"><ins>+&lt;p>Hello-Æ</ins></td></tr>
<tr id="47"><td class="linenumbers"> </td><td class="linenumbers">7252</td><td class="ins"><ins>+&lt;/p></ins></td></tr>
<tr id="48"><td class="linenumbers"> </td><td class="linenumbers">7253</td><td class="ins"><ins>+!! end</ins></td></tr>
<tr id="49"><td class="linenumbers"> </td><td class="linenumbers">7254</td><td class="ins"><ins>+</ins></td></tr>
<tr id="50"><td class="linenumbers">7237</td><td class="linenumbers">7255</td><td class="unchanged"><span> #</span></td></tr>
<tr id="51"><td class="linenumbers">7238</td><td class="linenumbers">7256</td><td class="unchanged"><span> #</span></td></tr>
<tr id="52"><td class="linenumbers">7239</td><td class="linenumbers">7257</td><td class="unchanged"><span> #</span></td></tr>
<tr id="53" class="patchedfile"><td colspan="3">Index: trunk/phase3/includes/parser/CoreParserFunctions.php</td></tr>



<tr id="57"><td class="linenumbers">—</td><td class="linenumbers">—</td><td class="chunkdelimiter"><span>@@ -310,20 +310,38 @@</span></td></tr>
<tr id="58"><td class="linenumbers">311</td><td class="linenumbers">311</td><td class="unchanged"><span> 		return $lang != '' ? $lang : $arg;</span></td></tr>
<tr id="59"><td class="linenumbers">312</td><td class="linenumbers">312</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="60"><td class="linenumbers">313</td><td class="linenumbers">313</td><td class="unchanged"><span> </span></td></tr>
<tr id="61"><td class="linenumbers">314</td><td class="linenumbers"> </td><td class="del"><del>-	static function pad( $string = '', $length = 0, $char = 0, $direction = STR_PAD_RIGHT ) {</del></td></tr>
<tr id="62"><td class="linenumbers">315</td><td class="linenumbers"> </td><td class="del"><del>-		$length = min( max( $length, 0 ), 500 );</del></td></tr>
<tr id="63"><td class="linenumbers">316</td><td class="linenumbers"> </td><td class="del"><del>-		$char = substr( $char, 0, 1 );</del></td></tr>
<tr id="64"><td class="linenumbers">317</td><td class="linenumbers"> </td><td class="del"><del>-		return ( $string !== '' &amp;&amp; (int)$length > 0 &amp;&amp; strlen( trim( (string)$char ) ) > 0 )</del></td></tr>
<tr id="65"><td class="linenumbers">318</td><td class="linenumbers"> </td><td class="del"><del>-				? str_pad( $string, $length, (string)$char, $direction )</del></td></tr>
<tr id="66"><td class="linenumbers">319</td><td class="linenumbers"> </td><td class="del"><del>-				: $string;</del></td></tr>
<tr id="67"><td class="linenumbers"> </td><td class="linenumbers">314</td><td class="ins"><ins>+	/**</ins></td></tr>
<tr id="68"><td class="linenumbers"> </td><td class="linenumbers">315</td><td class="ins"><ins>+	 * Unicode-safe str_pad with the restriction that $length is forced to be &lt;= 500</ins></td></tr>
<tr id="69"><td class="linenumbers"> </td><td class="linenumbers">316</td><td class="ins"><ins>+ 	 */</ins></td></tr>
<tr id="70"><td class="linenumbers"> </td><td class="linenumbers">317</td><td class="ins"><ins>+	static function pad( $string, $length, $padding = '0', $direction = STR_PAD_RIGHT ) {</ins></td></tr>
<tr id="71"><td class="linenumbers"> </td><td class="linenumbers">318</td><td class="ins"><ins>+		$lengthOfPadding = mb_strlen( $padding );		</ins></td></tr>
<tr id="72"><td class="linenumbers"> </td><td class="linenumbers">319</td><td class="ins"><ins>+		if ( $lengthOfPadding == 0 ) return $string;</ins></td></tr>
<tr id="73"><td class="linenumbers"> </td><td class="linenumbers">320</td><td class="ins"><ins>+		</ins></td></tr>
<tr id="74"><td class="linenumbers"> </td><td class="linenumbers">321</td><td class="ins"><ins>+		# The remaining length to add counts down to 0 as padding is added</ins></td></tr>
<tr id="75"><td class="linenumbers"> </td><td class="linenumbers">322</td><td class="ins"><ins>+		$length = min( $length, 500 ) - mb_strlen( $string );</ins></td></tr>
<tr id="76"><td class="linenumbers"> </td><td class="linenumbers">323</td><td class="ins"><ins>+		# $finalPadding is just $padding repeated enough times so that </ins></td></tr>
<tr id="77"><td class="linenumbers"> </td><td class="linenumbers">324</td><td class="ins"><ins>+		# mb_strlen( $string ) + mb_strlen( $finalPadding ) == $length</ins></td></tr>
<tr id="78"><td class="linenumbers"> </td><td class="linenumbers">325</td><td class="ins"><ins>+		$finalPadding = '';</ins></td></tr>
<tr id="79"><td class="linenumbers"> </td><td class="linenumbers">326</td><td class="ins"><ins>+		while ( $length > 0 ) {</ins></td></tr>
<tr id="80"><td class="linenumbers"> </td><td class="linenumbers">327</td><td class="ins"><ins>+			# If $length &lt; $lengthofPadding, truncate $padding so we get the</ins></td></tr>
<tr id="81"><td class="linenumbers"> </td><td class="linenumbers">328</td><td class="ins"><ins>+			# exact length desired.</ins></td></tr>
<tr id="82"><td class="linenumbers"> </td><td class="linenumbers">329</td><td class="ins"><ins>+			$finalPadding .= mb_substr( $padding, 0, $length );</ins></td></tr>
<tr id="83"><td class="linenumbers"> </td><td class="linenumbers">330</td><td class="ins"><ins>+			$length -= $lengthOfPadding;</ins></td></tr>
<tr id="84"><td class="linenumbers"> </td><td class="linenumbers">331</td><td class="ins"><ins>+		}</ins></td></tr>
<tr id="85"><td class="linenumbers"> </td><td class="linenumbers">332</td><td class="ins"><ins>+		</ins></td></tr>
<tr id="86"><td class="linenumbers"> </td><td class="linenumbers">333</td><td class="ins"><ins>+		if ( $direction == STR_PAD_LEFT ) {</ins></td></tr>
<tr id="87"><td class="linenumbers"> </td><td class="linenumbers">334</td><td class="ins"><ins>+			return $finalPadding . $string;</ins></td></tr>
<tr id="88"><td class="linenumbers"> </td><td class="linenumbers">335</td><td class="ins"><ins>+		} else {</ins></td></tr>
<tr id="89"><td class="linenumbers"> </td><td class="linenumbers">336</td><td class="ins"><ins>+			return $string . $finalPadding;</ins></td></tr>
<tr id="90"><td class="linenumbers"> </td><td class="linenumbers">337</td><td class="ins"><ins>+		}</ins></td></tr>
<tr id="91"><td class="linenumbers">320</td><td class="linenumbers">338</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="92"><td class="linenumbers">321</td><td class="linenumbers">339</td><td class="unchanged"><span> </span></td></tr>
<tr id="93"><td class="linenumbers">322</td><td class="linenumbers"> </td><td class="del"><del>-	static function padleft( $parser, $string = '', $length = 0, $char = 0 ) {</del></td></tr>
<tr id="94"><td class="linenumbers">323</td><td class="linenumbers"> </td><td class="del"><del>-		return self::pad( $string, $length, $char, STR_PAD_LEFT );</del></td></tr>
<tr id="95"><td class="linenumbers"> </td><td class="linenumbers">340</td><td class="ins"><ins>+	static function padleft( $parser, $string = '', $length = 0, $padding = '0' ) {</ins></td></tr>
<tr id="96"><td class="linenumbers"> </td><td class="linenumbers">341</td><td class="ins"><ins>+		return self::pad( $string, $length, $padding, STR_PAD_LEFT );</ins></td></tr>
<tr id="97"><td class="linenumbers">324</td><td class="linenumbers">342</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="98"><td class="linenumbers">325</td><td class="linenumbers">343</td><td class="unchanged"><span> </span></td></tr>
<tr id="99"><td class="linenumbers">326</td><td class="linenumbers"> </td><td class="del"><del>-	static function padright( $parser, $string = '', $length = 0, $char = 0 ) {</del></td></tr>
<tr id="100"><td class="linenumbers">327</td><td class="linenumbers"> </td><td class="del"><del>-		return self::pad( $string, $length, $char );</del></td></tr>
<tr id="101"><td class="linenumbers"> </td><td class="linenumbers">344</td><td class="ins"><ins>+	static function padright( $parser, $string = '', $length = 0, $padding = '0' ) {</ins></td></tr>
<tr id="102"><td class="linenumbers"> </td><td class="linenumbers">345</td><td class="ins"><ins>+		return self::pad( $string, $length, $padding );</ins></td></tr>
<tr id="103"><td class="linenumbers">328</td><td class="linenumbers">346</td><td class="unchanged"><span> 	}</span></td></tr>
<tr id="104"><td class="linenumbers">329</td><td class="linenumbers">347</td><td class="unchanged"><span> </span></td></tr>
<tr id="105"><td class="linenumbers">330</td><td class="linenumbers">348</td><td class="unchanged"><span> 	static function anchorencode( $parser, $text ) {</span></td></tr>
</table>
</div>
<h2 id='code-comments'>Comments</h2>
<div class='mw-codereview-comments'><div class="mw-codereview-comment" id="c1333" style="margin-left: 0px"><div class="mw-codereview-comment-meta"><a href="./45734.html#c1333" title="Special:Code/MediaWiki/45734">#</a>Comment by <a href="https://www.mediawiki.org/wiki/User:Brion_VIBBER" class="mw-userlink" title="User:Brion VIBBER"><bdi>Brion VIBBER</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Brion_VIBBER" class="mw-usertoollinks-talk" title="User talk:Brion VIBBER">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Brion_VIBBER" class="mw-usertoollinks-contribs" title="Special:Contributions/Brion VIBBER">contribs</a>)</span> &#160; 21:28, 20 January 2009 </div><div class="mw-codereview-comment-text mw-content-ltr"><p>Looks ok... :D
</p></div></div>
<div class="mw-codereview-comment" id="c2199" style="margin-left: 0px"><div class="mw-codereview-comment-meta"><a href="./45734.html#c2199" title="Special:Code/MediaWiki/45734">#</a>Comment by <a href="https://www.mediawiki.org/wiki/User:Plustgarten" class="mw-userlink" title="User:Plustgarten"><bdi>Plustgarten</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Plustgarten" class="mw-usertoollinks-talk" title="User talk:Plustgarten">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Plustgarten" class="mw-usertoollinks-contribs" title="Special:Contributions/Plustgarten">contribs</a>)</span> &#160; 21:17, 13 April 2009 </div><div class="mw-codereview-comment-text mw-content-ltr"><p>What if the padding character in padleft or padright is an HTML character code?  In particular, it sure would be useful if it could be (or include) an <b>&amp;nbsp;</b> (which should count as one character).  Could we get this effect by judicious application of something like <b>html_entity_decode()</b> to the padding string, before measuring it?
</p></div></div>
<div class="mw-codereview-comment" id="c2200" style="margin-left: 48px"><div class="mw-codereview-comment-meta"><a href="./45734.html#c2200" title="Special:Code/MediaWiki/45734">#</a>Comment by <a href="https://www.mediawiki.org/wiki/User:Simetrical" class="mw-userlink" title="User:Simetrical"><bdi>Simetrical</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Simetrical" class="mw-usertoollinks-talk" title="User talk:Simetrical">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Simetrical" class="mw-usertoollinks-contribs" title="Special:Contributions/Simetrical">contribs</a>)</span> &#160; 21:51, 13 April 2009 </div><div class="mw-codereview-comment-text mw-content-ltr"><p>Would be sensible.  Patches are welcome, post them on Bugzilla if you'd like.
</p></div></div></div><h2 id='code-changes'>Status &amp; tagging log</h2>
<ul class='mw-codereview-changes'><li>21:28, 20 January 2009&#160;<a href="https://www.mediawiki.org/wiki/User:Brion_VIBBER" class="mw-userlink" title="User:Brion VIBBER"><bdi>Brion VIBBER</bdi></a> <span class="mw-usertoollinks">(<a href="https://www.mediawiki.org/wiki/User_talk:Brion_VIBBER" class="mw-usertoollinks-talk" title="User talk:Brion VIBBER">talk</a> | <a href="https://www.mediawiki.org/wiki/Special:Contributions/Brion_VIBBER" class="mw-usertoollinks-contribs" title="Special:Contributions/Brion VIBBER">contribs</a>)</span>&#160;changed the <b>status</b> of r45734 <i>[<b>removed:</b> new&#160;<b>added:</b> ok]</i></li></ul></form></div>
</body>
</html>
 contentType 9 text/html url 64 https://static-codereview.wikimedia.org:443/MediaWiki/45734.html responseCode 3 200 